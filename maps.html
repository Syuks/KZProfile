<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>KZ Profile</title>
  <!-- Icon -->
  <link rel="icon" href="img/Logo.png" type="image/x-icon">
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.11.2/css/all.css">
  <!-- Google Fonts Roboto -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700&display=swap">
  <!-- Bootstrap core CSS -->
  <link rel="stylesheet" href="css/bootstrap.min.css">
  <!-- Material Design Bootstrap -->
  <link rel="stylesheet" href="css/mdb.min.css">
  <!-- Custom styles -->
  <link rel="stylesheet" href="css/style.css">
  <!-- MDBootstrap Datatables  -->
  <link href="css/addons/datatables.min.css" rel="stylesheet">
</head>
<body>

  <!-- Start -->  

    <!--Navbar-->
    <nav class="navbar navbar-expand-lg navbar-dark elegant-color">
      <div class="container">
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarToggler"
          aria-controls="navbarToggler" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbarToggler">
          <!-- Links -->
          <ul class="navbar-nav mr-auto">
            <li class="nav-item">
              <a class="nav-link" href="/">Profile</a>
            </li>
            <li class="nav-item active">
              <a class="nav-link" href="maps.html">Maps
                <span class="sr-only">(current)</span>
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="recent.html">Recent</a>
            </li>

            <!-- Dropdown -->
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" id="navbarDropdownCommunityLink" data-toggle="dropdown"
                aria-haspopup="true" aria-expanded="false">Community</a>
              <div class="dropdown-menu dropdown-primary" aria-labelledby="navbarDropdownCommunityLink">
								<a class="dropdown-item" href="leaderboard.html">Leaderboards</a>
								<a class="dropdown-item" href="servers.html">Servers</a>
                <a class="dropdown-item" href="players.html">Players</a>
                <a class="dropdown-item" href="bans.html">Bans</a>
              </div>
            </li>

            <!-- Dropdown -->
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" id="navbarDropdownMenuLink" data-toggle="dropdown"
                aria-haspopup="true" aria-expanded="false">Extras</a>
              <div class="dropdown-menu dropdown-primary" aria-labelledby="navbarDropdownMenuLink">
                <a class="dropdown-item" href="https://forum.gokz.org/" target="_blank">Forum</a>
                <a class="dropdown-item" href="https://syuks.github.io/DistbugCalculator/" target="_blank">Distbug Calculator</a>
                <a class="dropdown-item" href="https://www.youtube.com/c/Syuks" target="_blank">Tutorials</a>
              </div>
            </li>
          </ul>
          <!-- /Links -->

          <form id="multiPurposeForm" class="form-inline" method="GET" autocomplete="off" style="margin-right: 20px;">
            <div class="md-form my-0">
              <input id="multiPurposeInput" class="form-control mr-sm-2 multi-purpose-input" type="text" placeholder="Search" aria-label="Search" minlength="3">
              <i class="fas fa-search" aria-hidden="true"></i>
            </div>
          </form>
          <div id="userLogin"></div>

        </div>
      </div>
    </nav>
    <!--/.Navbar-->

    <div class="container">

      <!--Mode Chooser-->
      <div class="row configuration-row">
        <div class="col text-right" style="border-right: 2px solid white;">
          <!-- KZTimer -->
          <div class="custom-control-inline gameModeSelectors">
            <input class="configuration-radio" type="radio"  id="kztimerRadio" value="kz_timer" name="game_mode" checked>
            <label class="radio-label" for="kztimerRadio">KZ Timer</label>
          </div>

          <!-- SimpleKZ -->
          <div class="custom-control-inline gameModeSelectors">
            <input class="configuration-radio" type="radio" id="simplekzRadio" value="kz_simple" name="game_mode">
            <label class="radio-label" for="simplekzRadio">Simple KZ</label>
          </div>

          <!-- Vanilla -->
          <div class="custom-control-inline gameModeSelectors">
            <input class="configuration-radio" type="radio" id="vanillaRadio" value="kz_vanilla" name="game_mode">
            <label class="radio-label" for="vanillaRadio">Vanilla</label>
          </div>
        </div>

        <div class="col">
          <!-- PRO -->
          <div class="custom-control-inline" style="margin-left:16px">
            <input class="configuration-radio" type="radio" id="proRunsRadio" value="false" name="run_type" checked>
            <label class="radio-label" for="proRunsRadio">Pro</label>
          </div>

          <!-- TP -->
          <div class="custom-control-inline tpRunsSelector">
            <input class="configuration-radio" type="radio" id="tpRunsRadio" value="true" name="run_type">
            <label class="radio-label" for="tpRunsRadio">Tp</label>
          </div>

        </div>
      </div>
      <!--/.Mode Chooser-->

      <!--Map Information-->
      <div class="row" style="margin-top: 20px;">
        
        <!-- Map Image-->
        <div id="mapImage" class="col-lg-3 d-flex align-items-center">
          
        </div>

        <!--Map Name-->
        <div class="col-lg-9 text-nowrap MapData" style="padding-left: 20px;">
          <h1 style="font-size: 80px;">
            <span id="mapName"></span>
            <a id="bonus-activator" class="d-none dropdown-toggle" data-toggle="dropdown" style="font-size:24px;"></a>
            <div id="bonus-dropdown" class="dropdown-menu"></div>
          </h1>
          
          <h1 id="mapTier" style="font-weight: 400;">
            
          </h1>
        </div>
      </div>
      <!--/.Map Information-->

      <div class="row z-depth-1-half" style="margin-top: 30px;">
        <div class="col">

          <!-- TABLE HEADER -->
          <div class="row table-top">
            <!-- 1. Refresh Button -->
            <div class="col d-flex align-items-center" id="refreshColumn">
              <a id="refreshButton">
                <i class="fas fa-redo-alt"></i>
              </a>
              <a id="shareButton" style="margin-left: 15px;" data-toggle="tooltip" title="Copied to clipboard!" data-trigger="click">
                <i class="fas fa-share-alt"></i>
              </a>
            </div>
            <!-- 2. Table state changer -->
            <div class="col d-flex align-items-center justify-content-center">
              <a id="table-state-left" style="z-index: 1;" class="invisible">
                <i class="fas fa-angle-left"></i>
              </a>
              <div class="text-center" id="table-state-title" style="min-width: 150px;">
                Map Ranking
              </div>
              <a id="table-state-right" style="z-index: 1;">
                <i class="fas fa-angle-right"></i>
              </a>
            </div>
            <!-- 3. Search form -->
            <div class="col d-flex flex-row-reverse align-items-center">
              <form class="form-inline md-form form-sm mt-0 mb-0" autocomplete="off">
                <input id="mapRankingSearch" class="form-control form-control-sm mr-3 w-75" type="text" placeholder="Search" aria-label="Search">
                <i class="fas fa-search" aria-hidden="true"></i>
              </form>
            </div>
          </div>
          <div class="row">
            <!--Table-->
            <div class="table-responsive">
              <table id="MapRanking" class="table-sm table-borderless table-hover table-dark text-center text-nowrap">
                <thead class="z-depth-1">
                  <tr>
                    <th>#</th>
                    <th class="text-center th-lg">Player</th>
                    <th class="th-lg">Time</th>
                    <th class="th-lg">Points</th>
                    <th class="th-lg">TPs</th>
                    <th class="th-lg">Date</th>
                    <th class="th-lg">Server</th>
                  </tr>
                </thead>
              </table>
            </div>
            <!--Statistics-->
            <div id="ChartsContainer" class="col d-none w-100 text-center">
              <canvas id="WRsChart" style="margin-top: 20px;"></canvas>
              <canvas id="distributionChart" style="margin-top: 20px;"></canvas>
            </div>
          </div>
        </div>
      </div>

      <div id="mapImageModal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="mapImageModal" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered modal-xl" role="document">
        <div class="modal-content"  style="background-color: #121212;">
          <div class="modal-header">
            <div class="col-1"></div>
            <h5 class="modal-title col-10 text-center" id="mapImageModalTitle"></h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close" style="color:white;">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div id="mapImageModalContent" class="modal-body text-center">
            <div id="mapImageCarousel" class="carousel slide" data-interval="false">
              <div class="carousel-inner">
                <div class="carousel-item active">
                  <div id="mapImageVideo" class="embed-responsive embed-responsive-16by9">
                    
                  </div>
                </div>
                <div class="carousel-item">
                  <div class="embed-responsive embed-responsive-16by9">
                    <div id="mapImageFullRes" class="embed-responsive-item">

                    </div>
                  </div>
                </div>
                <div class="carousel-item">
                  <div class="embed-responsive embed-responsive-16by9">
                    <div class="embed-responsive-item workshop-container">
                      <h1>
                        <a id="WorkshopLink" href="" target="_blank">
                          <i class="fab fa-steam"></i>
                        </a>
                        <span id="WorkshopID" style="margin-left: 20px;"></span>
                      </h1>
                    </div>
                  </div>
                </div>
              </div>
              <!--/.Controls-->
              <ol class="carousel-indicators">
                <li data-target="#mapImageCarousel" data-slide-to="0" class="active">
                  <img id="mapImageVideoThumb" src="" width="100" height="56">
                  <div class="videoThumbOverlay"></div>
                </li>
                <li data-target="#mapImageCarousel" data-slide-to="1">
                  <img id="mapImageFullResThumb" src="" width="100" height="56" onerror='this.src="img/kz.png"'>
                </li>
                <li data-target="#mapImageCarousel" data-slide-to="2">
                  <img src="img/WorkshopThumb.png" width="100" height="56">
                </li>
              </ol>
            </div>
          </div>
          <div id="mapImageModalFooter" class="modal-footer justify-content-center text-center">
            Have a better video? <a href="https://forms.gle/FMgWkKjBc53HDpkf8" target="_blank"><u>Share it!</u></a>
          </div>
        </div>
      </div>
    </div>

    </div>  
    
  <!-- End -->

  <!-- jQuery -->
  <script type="text/javascript" src="js/jquery.min.js"></script>
  <!-- Bootstrap tooltips -->
  <script type="text/javascript" src="js/popper.min.js"></script>
  <!-- Bootstrap core JavaScript -->
  <script type="text/javascript" src="js/bootstrap.min.js"></script>
  <!-- Moment.js for time based charts.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js" integrity="sha512-qTXRIMyZIFb8iQcfjXWCO8+M5Tbc38Qi5WzdPOYZHIlZpzBHG3L3by84BBBOiRGiEb7KKtAOAs5qYdUiZiQNNQ==" crossorigin="anonymous"></script>
  <!-- MDB core JavaScript -->
  <script type="text/javascript" src="js/mdb.min.js"></script>
  <!-- Datatables  -->
  <script type="text/javascript" src="js/addons/datatables.min.js"></script>
  <!-- Autocomplete: https://github.com/Honatas/bootstrap-4-autocomplete  -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap-4-autocomplete/dist/bootstrap-4-autocomplete.min.js" crossorigin="anonymous"></script>
  <!-- My Utility functions-->
  <script type="text/javascript" src="js/myUtils.js"></script>
  <!-- Custom scripts -->
  <script type="text/javascript">

    var TIER = {
      7: "DEATH",
      6: "EXTREME",
      5: "VERY HARD",
      4: "HARD",
      3: "MEDIUM",
      2: "EASY",
      1: "VERY EASY",
    }

    var loggedSteamID32 = ""; //to highlight personal run in table

    //LOGIN LOGIC
    var storedSteamData = JSON.parse(localStorage.getItem('steamProfileData'));
    if (storedSteamData!=null) {
      $("#userLogin").html('<div class="dropdown"><a class="dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><img class="rounded-circle" src="' + storedSteamData.response.players[0].avatar + '"></a><div class="dropdown-menu"><a class="dropdown-item waves-effect waves-light" href="extras/steam.html?logout=true">Logout</a></div></div>');
      loggedSteamID32 = GetSteam32(storedSteamData.response.players[0].steamid);
    } else {
      $("#userLogin").html('<a onclick="loadOpenID();"><img src="https://community.cloudflare.steamstatic.com/public/images/signinthroughsteam/sits_01.png"></a>');
    }

    $(document).ready(function () {

      var currentRankingData;
      var currentWRsData;
      var currentDistributionData;
      var currentMapData = null; //global data from validated maps list

      var maps; //Maps JSON data for Tiers and Autocompletes
      var currentMap;
      var currentMapID; //used just for fetching bonuses (doesn't accept map_name parameter)
      var mapStage = 0;

      //Global so I can cancel the ajax request as soon as a new one is needed
      var rankingRequest;
      var mapsRequest;
      var recordFiltersRequest;
      var WRsRequest;
      var DistributionRequest;
      var WRBackupRequest; //for distribution chart
      var currentWR;//for distribution chart
      var PBRequest;
      var currentPB;//for distribution chart

      //usamos este bool para evitar problemas al cambiar el mode o run apenas carga la página
      var firstfetch = true;
      
      var tableState = 0;

      //bool for checking if we have already loaded the modal content
      var emptyModal = true;
      //bool for checking if we have already loaded the statistics
      var emptyStats = true;

      //Local Storage
      var storedGameMode = localStorage.getItem('game_mode');
      var storedRunType = localStorage.getItem('run_type');
      var storedMap = localStorage.getItem('map');
      var storedSteamData = JSON.parse(localStorage.getItem('steamProfileData')); //just for map distributions

      //UI Elements
      var multiPurposeInput = $("#multiPurposeInput");
      var gameModeSelector = $("input[type='radio'][name='game_mode']");
      var runTypeSelector = $("input[type='radio'][name='run_type']");
      var bonusActivator = $("#bonus-activator");
      var bonusDropdown = $("#bonus-dropdown");

      //Datatable Initialization
      var t = $('#MapRanking').DataTable({        
                  "iDisplayLength": 100,
                  "columnDefs": [
                    { "orderSequence": [ "desc", "asc" ], "targets": [3,5] }, //defines the direction the column sorts when first clicked
                    { "orderData": [2, 1], "targets": 2 }, //by doing this orering by time is consistent and we don't get points flipped
                    { "orderData": [3, 1], "targets": 3 }, //by doing this orering by points is consistent and we don't get times and indexes flipped
                    { "searchable": false, "orderable": false, "targets": 0 }, //para que no busquen ni ordenen la columna del index
                    { "className": "text-left", "targets": 6}, //para que los servers se justifiquen en la izquierda
                    { "className": "text-wrap text-left", "targets": 1} //la tabla usa text-truncate para que los servers sigan de largo, asi que le pongo wrap a los nombres para sobreescribirlo
                  ],
                  "order": [[ 3, "desc" ]], //DON'T CHANGE THIS, IT IS IMPOSSIBLE TO MAKE THE SECOND ORDER SORT BY POINTS "DESCENDING"
                  'rowCallback': function(row, data, index){      //tengo que cambiarles el color aca porque ponerlos con span no ordena numericamente
                    if (data[3]==1000){
                      $(row).find('td:eq(3)').css('color', '#e4ae39');
                    } else if(data[3] >= 900){
                      $(row).find('td:eq(3)').css('color', '#fa292e');
                    } else if (data[3] >= 800) {
                      $(row).find('td:eq(3)').css('color', '#5d96d6');
                    } else if (data[3] >= 700) {
                      $(row).find('td:eq(3)').css('color', '#4abc8d');
                    }
                    if (loggedSteamID32!="") { //if logged in
                      if(data[1].includes(loggedSteamID32)){
                        $(row).css('background-color', '#2E2E2E');
                      }
                    }
                  },
                  "dom": 'rt' //con esto elijo que partes de la datatable aparezcan: default: 'lfrtip' (length slector, filter input, ¿procesing element?, table, information, pagination)
                });
      $('.dataTables_length').addClass('bs-select');

      //WRs Chart Initialization
      var WRsCanvas = document.getElementById("WRsChart").getContext("2d");

      var WRsChart = new Chart(WRsCanvas, {
        type: 'line',
        data: {
          label: "WRs",
          datasets: [{
            label: 'WR Progression',
            steppedLine: "after",
            //lineTension: 0,
            //cubicInterpolationMode: 'monotone',
            players: [],
            data: [],
            backgroundColor: 'rgba(255, 99, 132, 0.2)',
            borderColor: 'rgba(255,99,132,1)',
            borderWidth: 2
          },
          {
            label: 'Current WR',
            steppedLine: "after",
            players: [],
            data: [],
            backgroundColor: 'rgba(54, 162, 235, .7)',
            borderColor: 'rgba(54, 162, 235, .7)',
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          scales: {
            xAxes: [{
              type: 'time'
            }],
            yAxes: [{
              ticks: {
                callback: function(value, index, values) {
                  let time = new Date(value * 1000).toISOString().substr(11, 11);
                  return time;
                }
              }
            }]
          },
          tooltips: {
            intersect: false,
            callbacks: {
              label: function(tooltipItem, data) {
                let dataset = data.datasets[tooltipItem.datasetIndex];
                let index = tooltipItem.index;
                let time = new Date(tooltipItem.yLabel * 1000).toISOString().substr(11, 11);
                return dataset.players[index] + ": " + time;
              }
            }
          }
        }
      });

      //Distribution Chart Initialization
      var DistributionCanvas = document.getElementById("distributionChart").getContext("2d");

      var DistributionChart = new Chart(DistributionCanvas, {
        type: 'line',
        data: {
          label: "Distribution",
          labels: [],
          datasets: [
          {
            label: 'PB',
            data: [],
            backgroundColor: ['rgba(54, 162, 235, .7)'],
            borderColor: ['rgba(54, 162, 235, .7)'],
            borderWidth: 2,
            radius: 4
          },
          {
            label: 'WR',
            data: [],
            backgroundColor: ['rgba(255, 206, 86, 0.2)'],
            borderColor: ['rgba(255, 206, 86, 1)'],
            borderWidth: 2,
            radius: 4
          },
          {
            label: 'Survival',
            //steppedLine: "after",
            //lineTension: 0,
            cubicInterpolationMode: 'monotone',
            data: [],
            backgroundColor: 'rgba(255, 99, 132, 0.2)',
            borderColor: 'rgba(255,99,132,1)',
            borderWidth: 2,
            radius: 0 //to hide the thousand points in the line
          }]
        },
        options: {
          responsive: true,
          hover: { //to show the point in the line while hovering
            mode: 'index',
            intersect: false,
          },
          scales: {
            xAxes: [{
              ticks: {
                autoskip: true, //automatic removal of overlapping labels
                callback: function (value, index, values) {
                  let time = new Date(value * 1000).toISOString().substr(11, 11);
                  return time;
                }
              }
            }]
          },
          legend: {
            reverse: true
          },
          tooltips: {
            mode: 'index',
            intersect: false,
            callbacks: {
              title: function(tooltipItem, data) {
                return "Time: " + tooltipItem[0].xLabel;
              }
            }
          }
        }
      });

      //If Enter is pressed on the multi purpose form
      $("#multiPurposeForm").submit(function( event ) {
        //it can be a map, a player name, a steam profile, a steam64 or a steam32
        let searchValue = multiPurposeInput.val();
        
        //MAP
        if (isValidKZMap(searchValue)) {
          currentMap = searchValue;
          firstfetch = true;
          mapStage = 0;
          GetMapData();
        //STEAM 32/64
        } else if (GetSteam32(searchValue)!=null) { //this function checks both 64 and 32 bit ids, will always return the 32 if input is valid
          window.location.href = "/?steamid=" + GetSteam32(searchValue);
        //Vanity Profiles
        } else if (isValidVanityProfile(searchValue)) {
          let vanityID = searchValue.split("/id/").pop().replace("/",""); //if there is a / at the end I don't want it, little unsafe
          $.ajax({
            url: "https://kzprofile.kreedz.top/api/v1/steam/vanity?url=" + vanityID,
            dataType: 'json',
            success: function(result){
              window.location.href = "/?steamid=" + GetSteam32(result.response.steamid);
            },
            error: function(){
              alert("Either this profile is invalid or the steam proxy is down.");
            }
          });
        //Legacy Profiles
        } else if (isValidSteamProfile(searchValue)) {
          window.location.href = "/?steamid=" + GetSteam32(searchValue.split("/profiles/").pop().match(/\d+/)); //just get the numbers, safer (steam64)
        //If they search for anything else, search a player with that name
        } else {
          window.location.href = "players.html?player=" + searchValue;
        }
        return false;
      });

      //focus multipurposeinput on empty key press
      $(document).on('keypress',function() {
        if ( $('input:focus').length == 0) {
          multiPurposeInput.focus();
        }
      });

      //maps ajax should be called only once
      if (maps==null && mapsRequest==null){
        mapsRequest = $.ajax({url: "https://kztimerglobal.com/api/v2.0/maps?is_validated=true&limit=1000", dataType: 'json', success: function(result){
          
          maps = result;
          
          //Autocomplete Initialization
          multiPurposeInput.autocomplete({
            source: maps,
            label: "name",
            treshold:2,
            onSelectItem: onSelectAutocomplete
          });

          //if we have ranking data, that means that it fetched faster than maps list and is waiting for maps ajax to succeed
          if (currentRankingData != null){
            ProcessMapData();
          }
          //if we don't have ranking data, it means that maps list data fetched faster, so do nothing. As soon as ranking data arrives, we'll start analyzing

        }});
      }

      //Autocomplete Selection Callback
      function onSelectAutocomplete (item, element) {
        currentMap = item.label;
        firstfetch = true;
        mapStage = 0;
        GetMapData();
      }

      //First of all see if there are parameters in url. If there is one, load data from that, if there isn't load saved ones
      var URLSearchParameters = new URLSearchParams(window.location.search);
      var mapNameParameter = URLSearchParameters.get("map");
      var gameModeParameter = URLSearchParameters.get("mode");
      var runTypeParameter = URLSearchParameters.get("run");
      var bonusParameter = URLSearchParameters.get("bonus");

      //GAME MODE PARAMETER
      if (gameModeParameter == "kz_timer" || gameModeParameter == "kz_simple" || gameModeParameter == "kz_vanilla"){
        $("input[type='radio'][name=game_mode][value=" + gameModeParameter + "]").prop('checked', true);
      } else {
        //If there is no gamemode in the url, get stored gamemode if there is one
        if (storedGameMode!=null){
          $("input[type='radio'][name=game_mode][value=" + storedGameMode + "]").prop('checked', true);
        }
      }

      //RUN TYPE PARAMETER
      if (runTypeParameter == "tp"){
        $("input[type='radio'][name=run_type][value=true]").prop('checked', true);
      } else if (runTypeParameter == "pro") {
        $("input[type='radio'][name=run_type][value=false]").prop('checked', true);
      } else {
        //If there is no runtype in the url, get stored runtype if there is one
        if (storedRunType!=null){
          $("input[type='radio'][name=run_type][value=" + storedRunType + "]").prop('checked', true);
        }
      }

      //BONUS PARAMETER
      if (bonusParameter!=null && bonusParameter!="" ){
        mapStage = bonusParameter;
      }

      //MAP PARAMETER
      if (mapNameParameter!=null && mapNameParameter!="" ){
        currentMap = mapNameParameter;
        firstfetch = true;
        GetMapData();
      } else if (storedMap!=null){
        //If there is no map on the url, get stored map if there is one
        currentMap = storedMap;
        firstfetch = true;
        GetMapData();
      } else {
        //this is the first time this person visits kzprofile, just show interstellar as example
        currentMap = "kz_zxp_interstellar_v2";
        firstfetch = true;
        GetMapData();
      }

      //If the radio group state is changed (Game Type)
      $("input[name='game_mode']").click(function() {
        GetMapData();
      });

      //If the radio group state is changed (Run Type)
      $("input[name='run_type']").click(function() {
        GetMapData();
      });

      //What happens when i click the Refresh Button on the table
      $("#refreshButton").click(function() {
        GetMapData();
      });

      //If the right arrow on table is pressed (Table State)
      $("#table-state-right").click(function() {
        //Ranking -> Statistics
        if (tableState == 0) { //redundant but safe
          tableState = 1;
          $("#table-state-title").html("Statistics");
          $("#table-state-right").addClass("invisible");
          $("#table-state-left").removeClass("invisible");
          $("#MapRanking").addClass("d-none");
          $("#ChartsContainer").removeClass("d-none");
          if (emptyStats) {
            GetChartData();
          }
        }
      });

      //If the left arrow on table is pressed (Table State)
      $("#table-state-left").click(function() {
        //Statistics -> Ranking
        if (tableState == 1) { //redundant but safe
          tableState = 0;
          if (mapStage == 0){
            $("#table-state-title").html("Map Ranking");
          } else {
            $("#table-state-title").html("Bonus " + mapStage + " Ranking");
          }
          $("#table-state-left").addClass("invisible");
          $("#table-state-right").removeClass("invisible");
          $("#ChartsContainer").addClass("d-none");
          $("#MapRanking").removeClass("d-none");
        }
      });

      //Getting the data from the API
      function GetMapData(){

        if (runTypeSelector.groupVal() == "true"){
          history.pushState({mapParams: "1"}, "", "?map=" + currentMap + "&mode=" + gameModeSelector.groupVal() + "&run=tp");
        } else if (runTypeSelector.groupVal() == "false") {
          history.pushState({mapParams: "1"}, "", "?map=" + currentMap + "&mode=" + gameModeSelector.groupVal() + "&run=pro");
        }

        //Primero que nada borramos todos los datos para mostrar que estamos buscando unos nuevos
        t.clear();
        t.draw();
        //también vaciamos el dropdown de bonus (podria hacerlo en firstfetch en realidad)
        bonusDropdown.html("");
        //y el wr asi luego sabemos si ya lo tenemos o no (ver distribution chart)
        currentWR = null;
        emptyStats = true;

        if (tableState == 0) {
          if (mapStage == 0){
            $("#table-state-title").html("Map Ranking");
          } else {
            $("#table-state-title").html("Bonus " + mapStage + " Ranking");
          }
        } else if (tableState == 1) {
          $("#table-state-title").html("Statistics");
        }

        //Refresh map image, name and tier only if we are fetching a new map (different map is detected inside text input)
        if (firstfetch){
          $("#mapImage").html("");
          $("#mapName").html("");
          $("#mapTier").html("");
          bonusActivator.addClass("d-none");

          $("#mapImageVideo").html('');
          $("#mapImageVideoThumb").attr('src', '');
          $("#mapImageFullRes").html('')
          $("#mapImageFullResThumb").attr('src', '');
          $("#WorkshopLink").attr('href', '');
          $("#WorkshopID").html('');
          emptyModal = true;
        }

        if (rankingRequest != null && rankingRequest.readyState < 4) {
          rankingRequest.abort();
        }

        rankingRequest = $.ajax({url: "https://kztimerglobal.com/api/v2.0/records/top?map_name=" + currentMap + "&tickrate=128&modes_list_string=" + gameModeSelector.groupVal() + "&has_teleports=" + runTypeSelector.groupVal() + "&stage=" + mapStage + "&limit=100", dataType: 'json', success: function(result){

          currentRankingData = result;

          //if we have map data, that means that it fetched faster than ranking and is waiting for ranking ajax to succeed
          if (maps != null) {
            ProcessMapData();
          }
          //if we don't have map data, it means that ranking data fetched faster, so do nothing. As soon as map data arrives, we'll start analyzing
        }});
      }

      function ProcessMapData() {

        if (firstfetch) {
          currentMapData = null;
          //get global map information (tier, workshop, validation)
          for (let i = 0; i < maps.length; i++){
            if (maps[i].name == currentMap){
              currentMapData = maps[i];
              break;
            }
          }
        }

        if (currentRankingData.length > 0){
          currentMapID = currentRankingData[0].map_id;
          currentWR = currentRankingData[0].time;
          localStorage.setItem('map', currentMap); //recien ahora lo guardamos, antes de aca no sabemos si es valido
          ShowMapData();
          if (firstfetch) {
            firstfetch = false;
            ShowMapInformation();
          }
          if (tableState== 1) {
            GetChartData();
          }
        } else { //si vino vacia es porque no hay datos sobre ese mapa pero tal vez tenga runs en otro modo de juego o run type
          if (firstfetch) {
            if (currentMapData!=null) {
              currentMapID = currentMapData.id;
              localStorage.setItem('map', currentMap); //recien ahora lo guardamos, antes de aca no sabemos si es valido
              firstfetch = false;
              ShowMapInformation();
              EmptyWRsChart();
              EmptyDistributionChart();
              alert("This map has 0 runs in this stage, game mode and run type.");
            } else {
              alert("This map is either not global or doesn't exist.");
            }
          } else {
            EmptyWRsChart();
            EmptyDistributionChart();
            alert("This map has 0 runs in this stage, game mode and run type.");
          }
        }
      }

      function ShowMapData(){

        let arr = currentRankingData;

        for (let i = 0; i < arr.length; i++) {
          
          //Transform time
          var map_time = new Date(arr[i].time * 1000).toISOString().substr(11, 11);

          t.row.add( [
            "",
            '<a href="/?steamid=' + arr[i].steam_id + '">' + arr[i].player_name + '</a>',
            map_time,
            arr[i].points,
            arr[i].teleports,
            arr[i].updated_on.substr(0,10),
            arr[i].server_name
          ] );
        }

        t.draw();

        //For some reason when two times are identical, the API returns them with points flipped (higher points below).
        //For this reason I can't add the array index directly to the row, and have to create the indexes after ordering by points
        //Ordering by time and points MUST have this index as secord order parameter, so it's consistent, see "orderData" on "columnDefs" at datatable initialization
        t.column(0).nodes().each(function(cell, i){
          cell.innerHTML = i + 1;
        }).draw();
      }

      //Esta data solo se pide/muestra si es un nuevo mapa
      function ShowMapInformation (){

        //NAME
        $("#mapName").html(currentMap);
        document.title = currentMap;
        //show dropdown, reset ajax bonus request and clear dropdown items
        bonusActivator.removeClass("d-none");
        recordFiltersRequest = null;

        //IMAGE
        $("#mapImage").html('<a data-toggle="modal" data-target="#mapImageModal"><img class="img-fluid" src="https://raw.githubusercontent.com/KZGlobalTeam/map-images/public/webp/' + currentMap + `.webp" onerror='this.src="img/kz.png"' id="` + currentMap + `"></a>`);
        
        //TIER
        if (currentMapData!=null) {
          $("#mapTier").html('<span class="' + TIER[currentMapData.difficulty].replace(/ /g, "-") + '">' + TIER[currentMapData.difficulty] + '</span>');
        } else {
          $("#mapTier").html('<span style="color:grey">NOT GLOBAL</span>');
        }
      }

      function GetChartData () {

        //------------------------WR CHART------------------------//

        if (WRsRequest != null && WRsRequest.readyState < 4) {
          WRsRequest.abort();
        }
        
        WRsRequest = $.ajax({url: "https://kztimerglobal.com/api/v2.0/records/top/recent?map_name=" + currentMap + "&tickrate=128&modes_list_string=" + gameModeSelector.groupVal() + "&has_teleports=" + runTypeSelector.groupVal() + "&stage=" + mapStage + "&place_top_at_least=1" , dataType: 'json',
          success: function(result){

            currentWRsData = result;

            if (currentWRsData.length > 0) {

              //WR history
              WRsChart.data.datasets[0].players = [];
              WRsChart.data.datasets[0].data = [];
              //WR current
              WRsChart.data.datasets[1].players = [];
              WRsChart.data.datasets[1].data = [];

              for (let i = 0; i < currentWRsData.length; i++) {
                if (i == 0) {
                  WRsChart.data.datasets[1].data.push({t: moment(), y: currentWRsData[i].time});
                  WRsChart.data.datasets[1].players.push("Still standing");
                  
                  WRsChart.data.datasets[1].data.push({t: moment(currentWRsData[i].updated_on), y: currentWRsData[i].time});
                  WRsChart.data.datasets[1].players.push(currentWRsData[i].player_name);
                }
                WRsChart.data.datasets[0].data.push({t: moment(currentWRsData[i].updated_on), y: currentWRsData[i].time});
                WRsChart.data.datasets[0].players.push(currentWRsData[i].player_name);
              }
              emptyStats = false;
              WRsChart.update();
            } else {
              EmptyWRsChart(); //if no wrs, show empty graph
            }
          },
          error: function(){
            EmptyWRsChart(); //if no wrs, show empty graph
          }
        });

        //------------------------DISTRIBUTION CHART------------------------//

        let chart_mode_id = gameModeID(gameModeSelector);

        if (DistributionRequest != null && DistributionRequest.readyState < 4) {
          DistributionRequest.abort();
        }

        DistributionRequest = $.ajax({url: "https://kztimerglobal.com/api/v2.0/record_filters/distributions?map_ids=" + currentMapID + "&has_teleports=" + runTypeSelector.groupVal() + "&stage=" + mapStage + "&mode_ids=" +  chart_mode_id, dataType: 'json',
          success: function(result){
          
            currentDistributionData = result;

            if (currentDistributionData.length > 0) {

              DistributionChart.data.datasets[0].data = []; //PB
              DistributionChart.data.datasets[1].data = []; //WR
              DistributionChart.data.datasets[2].data = []; //Survival
              DistributionChart.data.labels = [];

              //SOURCE: https://docs.scipy.org/doc/scipy/reference/generated/scipy.stats.burr12.html

              //shape of the curve, parameter c (>0)
              let c = currentDistributionData[0].c;
              //shape of the curve, parameter d (>0)
              let d = currentDistributionData[0].d;
              //loc represents the location of the curve. It's used to shift x (seconds, time) to where the curve starts (run times start)
              let loc = currentDistributionData[0].loc;
              //scale is used to scale the curve (>0)
              let scale = currentDistributionData[0].scale;

              //hard cap: time limit in seconds (3 hours)
              let timeLimit = 3 * 60 * 60;

              //x represents time in seconds. will be the x axis, the casing for the distribution curve (>=0)
              for (let x = 0; x < timeLimit; x++) {

                //soft cap, there are 0/almost 0 runs past this "time" (1+(y^c))^-d
                if(burr12percentile(x, c, d, loc, scale) < 0.1){
                  break;
                }

                DistributionChart.data.datasets[2].data.push(burr12(x, c, d, loc, scale));
                DistributionChart.data.labels.push(x);
              }
              //wait for wr to draw the chart

              //WR inside distribution chart.
              //If ranking data has not arrieved yet, then we don't know the wr. If that's the case, fetch it (only happens when pressing table arrow before loading current ranking data)
              if (currentWR == null) {

                if (WRBackupRequest != null && WRBackupRequest.readyState < 4) {
                  WRBackupRequest.abort();
                }

                WRBackupRequest = $.ajax({url: "https://kztimerglobal.com/api/v2.0/records/top?map_name=" + currentMap + "&tickrate=128&stage=" + mapStage + "&modes_list_string=" + gameModeSelector.groupVal() + "&has_teleports=" + runTypeSelector.groupVal() + "&limit=1", dataType: 'json', success: function(result){
                  if (result.length > 0) {
                    currentWR = result[0].time;
                    DistributionChart.data.datasets[1].data[Math.round(currentWR)] = burr12(currentWR, c, d, loc, scale);
                    DistributionChart.update(); //update now, if there is a pb, we'll update again when we get it
                  } //if it's 0 then there are no wrs, do nothing, really weird
                }});

              } else {
                DistributionChart.data.datasets[1].data[Math.round(currentWR)] = burr12(currentWR, c, d, loc, scale);
                DistributionChart.update(); //update now, if there is a pb, we'll update again when we get it
              }

              //PB inside distribution chart
              if (storedSteamData != null) { //si inicio sesion

                currentPB = null;
                
                if (PBRequest != null && PBRequest.readyState < 4) {
                  PBRequest.abort();
                }

                PBRequest = $.ajax({url: "https://kztimerglobal.com/api/v2.0/records/top?steamid64=" + storedSteamData.response.players[0].steamid + "&map_id=" + currentMapID + "&tickrate=128&has_teleports=" + runTypeSelector.groupVal() + "&stage=" + mapStage + "&modes_list_string=" +  gameModeSelector.groupVal(), dataType: 'json', success: function(result){
                  if (result.length > 0) {
                    currentPB = result[0].time;
                    DistributionChart.data.datasets[0].data[Math.round(currentPB)] = burr12(currentPB, c, d, loc, scale);
                    DistributionChart.update();
                  } //if it's 0 then do nothing, you have no pb in this map
                }});
              }

            } else {
              EmptyDistributionChart(); //if there is no distribution data yet, show an empty chart
            }
          },
          error: function(){
            EmptyDistributionChart(); //on error, show empty graph
          }
        });
      }

      function EmptyWRsChart() {

        emptyStats = false;

        //WR history
        WRsChart.data.datasets[0].players = [];
        WRsChart.data.datasets[0].data = [];
        //WR current
        WRsChart.data.datasets[1].players = [];
        WRsChart.data.datasets[1].data = [];

        WRsChart.update();
      }

      function EmptyDistributionChart () {
        
        DistributionChart.data.datasets[0].data = []; //PB
        DistributionChart.data.datasets[1].data = []; //WR
        DistributionChart.data.datasets[2].data = []; //Survival
        DistributionChart.data.labels = [];

        DistributionChart.update();
      }

      //If bonus dropdown arrow is clicked
      bonusActivator.click(function() {
        GetRecordFilters ();
      });

      function GetRecordFilters () {
        //pido todos los filtros de una y proceso despues para no sobrecargar la api con 1 consulta cada vez que apretan el dropdown y es el mismo mapa
        if (recordFiltersRequest==null){ //para pedirlo solo una vez, reseteamos a null cuando cambiamos de mapa, no de modo/run type
          recordFiltersRequest = $.ajax({url: "https://kztimerglobal.com/api/v2.0/record_filters?map_ids=" + currentMapID, dataType: 'json', success: function(result){
            ShowRecordFilters(result);
          }});
        } else {
          ShowRecordFilters(JSON.parse(recordFiltersRequest.responseText));
        }
      }

      function ShowRecordFilters (filters) {
        let bonus_mode_id = gameModeID(gameModeSelector);
        
        let bonus_has_teleports = Boolean(runTypeSelector.groupVal());

        //Although this method runs the for loop again, it's much simpler to code and forward compatible. The for loop is not expensive.
        bonusDropdown.html("");

        let hasMainMap = false; //just two simple checks to see if I should place a dropdown-divider
        let hasBonuses = false;
        for (let i = 0; i < filters.length; i++) {
          if (filters[i].mode_id == bonus_mode_id && filters[i].has_teleports == bonus_has_teleports && filters[i].tickrate == "128") {
            if (filters[i].stage == 0){
              if (hasBonuses) { //because sometimes bonuses arrive first
                bonusDropdown.prepend('<div class="dropdown-divider"></div>');
              }
              hasMainMap = true;
              bonusDropdown.prepend('<a id="0" class="dropdown-item text-white">Main Map</a>');
            } else {
              if (hasMainMap && !hasBonuses) {
                bonusDropdown.append('<div class="dropdown-divider"></div>');
              }
              hasBonuses = true;
              bonusDropdown.append('<a id="' + filters[i].stage + '" class="dropdown-item text-white">Bonus ' + filters[i].stage + '</a>');
            }
          }
        }
      }

      //What happens when a bonus is selected
      bonusDropdown.on('click', 'a.dropdown-item', function() {
        mapStage = $(this).attr('id');
        GetMapData();
      });

      //What happens when modal shows up
      $("#mapImageModal").on('show.bs.modal', function(){
        if (emptyModal) {

          let imageMapName = event.target.id;
          $("#mapImageModalTitle").html(imageMapName);

          //IMAGE
          $("#mapImageFullRes").html('<img class="img-fluid" src="https://raw.githubusercontent.com/KZGlobalTeam/map-images/public/images/' + imageMapName + `.jpg" onerror='this.src="img/kz.png"'>`)
          $("#mapImageFullResThumb").attr('src', 'https://raw.githubusercontent.com/KZGlobalTeam/map-images/public/webp/' + imageMapName + '.webp');

          //WORKSHOP
          let workshopURL;
          if (currentMapData!=null) { //si es global...
            workshopURL = currentMapData.workshop_url;
            if (workshopURL != "") {
              $("#WorkshopLink").attr('href', workshopURL);
              $("#WorkshopID").html(workshopURL.substring(55));
            } else {
              $("#WorkshopLink").attr('href', '');
              $("#WorkshopID").html('The url is missing from the api. Please report this issue.');
            }
          } else {
            $("#WorkshopLink").attr('href', '');
            $("#WorkshopID").html('This map is not global.');
          }

          //VIDEO
          let videoURL;
          let videoThumb;

          $.getJSON( "js/videos.json", function( data ) {

            if (data[imageMapName] != null) {
              videoURL = data[imageMapName];
              videoThumb = "https://img.youtube.com/vi/" + videoURL.substring(26, 37) + "/0.jpg";
              $("#mapImageVideo").html('<iframe class="embed-responsive-item" src="' + videoURL + '"></iframe>');
              $("#mapImageVideoThumb").attr('src', videoThumb);
              $("#mapImageCarousel").carousel(0);
            } else {
              $("#mapImageVideo").html(`<div class="embed-responsive-item d-flex align-items-center justify-content-center">
                                          <div>
                                            <h1>KZ Profile</h1>
                                            <p>There is currently no youtube video for this map.</p>
                                            <p>If you have one, you can contribute to the site by submitting the link <a href="https://forms.gle/FMgWkKjBc53HDpkf8" target="_blank"><u>here</u></a>.</p>
                                            <p><img src="img/YTError.png"></p>
                                          </div>
                                        </div>`);
              $("#mapImageVideoThumb").attr('src', 'img/kz.png');
              //if there is no video, just show the image
              $("#mapImageCarousel").carousel(1);
            }

            //a esta altura terminamos de procesar todo lo necesario para el modal, ya no esta vacio
            emptyModal = false;

          });
        }
      });

      //sinconizar la search box con la tabla
      $('#mapRankingSearch').keyup(function(){
        t.search($(this).val()).draw();
      });

      //Tooltip initialization
      $('[data-toggle="tooltip"]').tooltip();
      //Copy to clipboard Functionality
      $('[data-toggle="tooltip"]').click(function(){

        let urlRunType;
        if (runTypeSelector.groupVal() == "true") {
          urlRunType = "tp";
        } else if (runTypeSelector.groupVal() == "false") {
          urlRunType = "pro";
        }

        let sharableURL = window.location.host + window.location.pathname;

        if (currentMap !=null) {
          if (mapStage==0){
            sharableURL += "?map=" + currentMap + "&mode=" + gameModeSelector.groupVal() + "&run=" + urlRunType;
          } else {
            sharableURL += "?map=" + currentMap + "&mode=" + gameModeSelector.groupVal() + "&run=" + urlRunType + "&bonus=" + mapStage;
          }
          
          const copyText = document.createElement('textarea');
          copyText.value = sharableURL;
          document.body.appendChild(copyText);
          copyText.select();
          document.execCommand('copy');
          document.body.removeChild(copyText);

          var shareTooltip = $(this)
          shareTooltip.tooltip('show');
          setTimeout(function(){
            shareTooltip.tooltip('hide');
          }, 2000);

        } else {
          alert("Please select a map first.")
        }
      });

    });
  </script>

</body>
</html>