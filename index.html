<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>KZ Profile</title>
  <!-- Icon -->
  <link rel="icon" href="img/Logo.png" type="image/x-icon">
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.11.2/css/all.css">
  <!-- Google Fonts Roboto -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700&display=swap">
  <!-- Bootstrap core CSS -->
  <link rel="stylesheet" href="css/bootstrap.min.css">
  <!-- Material Design Bootstrap -->
  <link rel="stylesheet" href="css/mdb.min.css">
  <!-- Custom styles -->
  <link rel="stylesheet" href="css/style.css">
  <!-- MDBootstrap Datatables  -->
  <link href="css/addons/datatables.min.css" rel="stylesheet">
</head>
<body>

  <!-- Start -->  

    <!--Navbar-->
    <nav class="navbar navbar-expand-lg navbar-dark elegant-color">
      <div class="container">
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarToggler"
          aria-controls="navbarToggler" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbarToggler">
          <!-- Links -->
          <ul class="navbar-nav mr-auto">
            <li class="nav-item active">
              <a class="nav-link" href="/">Profile
                <span class="sr-only">(current)</span>
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="maps.html">Maps</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="recent.html">Recent</a>
            </li>

            <!-- Dropdown -->
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" id="navbarDropdownCommunityLink" data-toggle="dropdown"
                aria-haspopup="true" aria-expanded="false">Community</a>
              <div class="dropdown-menu dropdown-primary" aria-labelledby="navbarDropdownCommunityLink">
								<a class="dropdown-item" href="leaderboard.html">Leaderboards</a>
								<a class="dropdown-item" href="servers.html">Servers</a>
                <a class="dropdown-item" href="players.html">Players</a>
                <a class="dropdown-item" href="bans.html">Bans</a>
              </div>
            </li>

            <!-- Dropdown -->
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" id="navbarDropdownMenuLink" data-toggle="dropdown"
                aria-haspopup="true" aria-expanded="false">Extras</a>
              <div class="dropdown-menu dropdown-primary" aria-labelledby="navbarDropdownMenuLink">
                <a class="dropdown-item" href="https://forum.gokz.org/" target="_blank">Forum</a>
                <a class="dropdown-item" href="https://syuks.github.io/DistbugCalculator/" target="_blank">Distbug Calculator</a>
                <a class="dropdown-item" href="https://www.youtube.com/c/Syuks" target="_blank">Tutorials</a>
              </div>
            </li>
          </ul>
          <!-- Links -->
          <form id="multiPurposeForm" class="form-inline" method="GET" autocomplete="off" style="margin-right: 20px;">
            <div class="md-form my-0">
              <input id="multiPurposeInput" class="form-control mr-sm-2 multi-purpose-input" type="text" placeholder="Search" aria-label="Search" minlength="3">
              <i class="fas fa-search" aria-hidden="true"></i>
            </div>
          </form>
          <div id="userLogin"></div>
        </div>
      </div>
    </nav>
    <!--/.Navbar-->

    <div class="container">

      <!--Mode Chooser-->
      <div class="row configuration-row">
        <div class="col text-right" style="border-right: 2px solid white;">
          <!-- KZTimer -->
          <div class="custom-control-inline gameModeSelectors">
            <input class="configuration-radio" type="radio"  id="kztimerRadio" value="kz_timer" name="game_mode" checked>
            <label class="radio-label" for="kztimerRadio">KZ Timer</label>
          </div>

          <!-- SimpleKZ -->
          <div class="custom-control-inline gameModeSelectors">
            <input class="configuration-radio" type="radio" id="simplekzRadio" value="kz_simple" name="game_mode">
            <label class="radio-label" for="simplekzRadio">Simple KZ</label>
          </div>

          <!-- Vanilla -->
          <div class="custom-control-inline gameModeSelectors">
            <input class="configuration-radio" type="radio" id="vanillaRadio" value="kz_vanilla" name="game_mode">
            <label class="radio-label" for="vanillaRadio">Vanilla</label>
          </div>
        </div>

        <div class="col">
          <!-- PRO -->
          <div class="custom-control-inline" style="margin-left:16px">
            <input class="configuration-radio" type="radio" id="proRunsRadio" value="false" name="run_type" checked>
            <label class="radio-label" for="proRunsRadio">Pro</label>
          </div>

          <!-- TP -->
          <div class="custom-control-inline tpRunsSelector">
            <input class="configuration-radio" type="radio" id="tpRunsRadio" value="true" name="run_type">
            <label class="radio-label" for="tpRunsRadio">Tp</label>
          </div>

        </div>
      </div>
      <!--Mode Chooser-->

      <div class="alert alert-warning alert-dismissible fade show d-none" role="alert" style="margin-top: 20px;">
        <strong>You are not signed in.</strong> To see your KZ profile please first <strong><a onclick="loadOpenID();">sign in</a></strong> to your Steam account. You can still use all the rest of the features in the site.
        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>

      <!--Profile Portfolio-->
      <div class="row" style="margin-top: 20px;">
        
        <!--Profile Picture-->
        <div id="playerAvatar" class="col-lg-2 d-flex align-items-center" style="padding-left:5px;">
          
        </div>

        <!--Profile Medals-->
        <div class="col-sm-10">
          <div id="playerCarousel" class="carousel slide" data-interval="false">
            <div class="carousel-inner">
              <div class="carousel-item active">
                <div class="row" style="min-height: 222px;">
                  <div class="col-lg-2 text-center MedalsColumn" style="padding-left:50px">
                    <h1 id="WRs_medals" class="WRMedals" style="margin-top:8px;margin-bottom:0px;">
                      
                    </h1>
                    <h1 id="900s_medals" class="RedMedals" style="margin-top:14px;margin-bottom:2px;">
                      
                    </h1>
                    <h1 id="800s_medals" class="BlueMedals" style="margin-bottom:0px">
                      
                    </h1>
                  </div>
          
                  <!--Profile Data-->
                  <div class="col-lg-10 ProfileData" style="padding-left: 30px;">
                    <h1 id="playerName" class="text-nowrap" style="font-size: 80px;">
                      
                    </h1>
                    <h1 id="playerPoints" style="color: #bcbcbc;">
                    
                    </h1>
                    <h1 id="playerRank" style="color: #cf4479;font-weight: 400;">
                      
                    </h1>
                  </div>
                </div>
              </div>
              <div class="carousel-item">
                <div class="row" style="min-height: 222px;">
                  <div class="col-lg-12 achievementsColumn" style="padding-right: 50px; padding-left: 50px;">
                    <h1 style="padding-left: 20px;">Achievements</h1>
                    <div id="HiddenStickers" class="text-center">
                    </div>
                    <a data-toggle="modal" data-target="#singleBadgeModal"><img src="img/Stickers/80/Robo-Empty.png" id="veasy"></a>
                    <a data-toggle="modal" data-target="#singleBadgeModal"><img src="img/Stickers/80/SAS-Chicken-Empty.png" id="easy"></a>
                    <a data-toggle="modal" data-target="#singleBadgeModal"><img src="img/Stickers/80/Cluck-Empty.png" id="medium"></a>
                    <a data-toggle="modal" data-target="#singleBadgeModal"><img src="img/Stickers/80/Toxic-Empty.png" id="hard"></a>
                    <a data-toggle="modal" data-target="#singleBadgeModal"><img src="img/Stickers/80/Nuke-Beast-Empty.png" id="vhard"></a>
                    <a data-toggle="modal" data-target="#singleBadgeModal"><img src="img/Stickers/80/Aztec-Empty.png" id="extreme"></a>
                    <a data-toggle="modal" data-target="#singleBadgeModal"><img src="img/Stickers/80/Emperor-Empty.png" id="death"></a>
                    <a data-toggle="modal" data-target="#singleBadgeModal"><img src="img/Stickers/80/zPrince-Empty.png" id="zhop"></a>
                    <a data-toggle="modal" data-target="#singleBadgeModal"><img src="img/Stickers/80/Gold-Web-Empty.png" id="kzra"></a>
                    <a data-toggle="modal" data-target="#singleBadgeModal"><img src="img/Stickers/80/Boost-Empty.png" id="bhop"></a>
                    <a data-toggle="modal" data-target="#singleBadgeModal"><img src="img/Stickers/80/CS20-Classic-Empty.png" id="xc"></a>
                    <a data-toggle="modal" data-target="#singleBadgeModal"><img src="img/Stickers/80/Fancy-Koi-Empty.png" id="moto"></a>
                    <a data-toggle="modal" data-target="#singleBadgeModal"><img src="img/Stickers/80/Guinea-Pig-Empty.png" id="final"></a>
                    <a data-toggle="modal" data-target="#singleBadgeModal"><img src="img/Stickers/80/Longevity-Empty.png" id="od"></a>
                    <a data-toggle="modal" data-target="#singleBadgeModal"><img src="img/Stickers/80/Move-It-Empty.png" id="bkz"></a>
                    <a data-toggle="modal" data-target="#singleBadgeModal"><img src="img/Stickers/80/Pros-Dont-Fix-Empty.png" id="fix"></a>
                    <a data-toggle="modal" data-target="#singleBadgeModal"><img src="img/Stickers/80/Remake-Expert-Empty.png" id="v2"></a>
                    <a data-toggle="modal" data-target="#singleBadgeModal"><img src="img/Stickers/80/Stay-Frosty-Empty.png" id="gfy"></a>
                    <a data-toggle="modal" data-target="#singleBadgeModal"><img src="img/Stickers/80/Surfs-Up-Empty.png" id="slide"></a>
                    <a data-toggle="modal" data-target="#singleBadgeModal"><img src="img/Stickers/80/Too-Old-For-This-Empty.png" id="go"></a>
                  </div>
                </div>
              </div>
              <div class="carousel-item">
                <div class="row">
                  <div class="col-lg-6 text-center barsColumn" style="padding-left: 75px;">
                    <div id="barsTitle" style="margin-bottom:15px;font-weight:400">Completions</div>
                    <div class="progress" style="height: 4px; margin-bottom:22px; background-color: #1b411b;">
                      <div id="VeryEasyBar" class="progress-bar" role="progressbar" style="background-color: #40fe40;"></div>
                    </div>
                    <div class="progress" style="height: 4px; margin-bottom:22px; background-color: #2f411d;">
                      <div id="EasyBar" class="progress-bar" role="progressbar" style="background-color: #a1fe47;"></div>
                    </div>
                    <div class="progress" style="height: 4px; margin-bottom:22px; background-color: #3e3c27;">
                      <div id="MediumBar" class="progress-bar" role="progressbar" style="background-color: #ece37a;"></div>
                    </div>
                    <div class="progress" style="height: 4px; margin-bottom:22px; background-color: #3c311a;">
                      <div id="HardBar" class="progress-bar" role="progressbar" style=" background-color: #e4ae39;"></div>
                    </div>
                    <div class="progress" style="height: 4px; margin-bottom:22px; background-color: #411b1b;">
                      <div id="VeryHardBar" class="progress-bar" role="progressbar" style="background-color: #fe4040;"></div>
                    </div>
                    <div class="progress" style="height: 4px; margin-bottom:22px; background-color: #410e0e;">
                      <div id="ExtremeBar" class="progress-bar" role="progressbar" style="background-color: #fe0000;"></div>
                    </div>
                    <div class="progress" style="height: 4px; background-color: #38173c;">
                      <div id="DeathBar" class="progress-bar" role="progressbar" style="background-color: #d22ce5;"></div>
                    </div>
                  </div>
                  <div class="col-lg-6">
                    <canvas id="radarChart"></canvas>
                  </div>
                </div>
              </div>
            </div>
            <a class="carousel-control-prev" href="#playerCarousel" role="button" data-slide="prev">
              <span class="carousel-control-prev-icon" aria-hidden="true"></span>
              <span class="sr-only">Previous</span>
            </a>
            <a class="carousel-control-next" href="#playerCarousel" role="button" data-slide="next">
              <span class="carousel-control-next-icon" aria-hidden="true"></span>
              <span class="sr-only">Next</span>
            </a>
          </div>
        </div>
      </div>
      <!--/.Profile Portfolio-->

      <div class="row z-depth-1-half" style="margin-top: 24px;">
        <div class="col">

          <!-- TABLE HEADER -->
          <div class="row table-top">
            <!-- 1. Refresh Button -->
            <div class="col d-flex align-items-center" id="refreshColumn">
              <a id="refreshButton">
                <i class="fas fa-redo-alt"></i>
              </a>
              <a id="shareButton" style="margin-left: 15px;" data-toggle="tooltip" title="Copied to clipboard!" data-trigger="click">
                <i class="fas fa-share-alt"></i>
              </a>
            </div>
            <!-- 2. Table state changer -->
            <div class="col d-flex align-items-center justify-content-center">
              <a id="table-state-left" style="z-index: 1;">
                <i class="fas fa-angle-left"></i>
              </a>
              <div class="text-center" id="table-state-title" style="min-width: 150px;">
                Finished Maps
              </div>
              <a id="table-state-right" style="z-index: 1;">
                <i class="fas fa-angle-right"></i>
              </a>
            </div>
            <!-- 3. Search form -->
            <div class="col d-flex flex-row-reverse align-items-center">
              <form class="form-inline md-form form-sm mt-0 mb-0" autocomplete="off" onsubmit="return false">
                <input id="finishedMapsSearch" class="form-control form-control-sm mr-3 w-75" type="text" placeholder="Search" aria-label="Search">
                <i class="fas fa-search" aria-hidden="true"></i>
              </form>
            </div>
          </div>

          <!-- TABLES -->
          <div class="row">
            <!-- UNFINISHED MAPS TABLE -->
            <div class="table-responsive">
              <table id="UnfinishedMaps" class="d-none table-sm table-borderless table-hover table-dark text-center">
                <thead class="z-depth-1">
                  <tr>
                    <th class="text-center th-lg">Map</th>
                    <th class="th-lg">Points</th>
                    <th class="th-lg">Time</th>
                    <th class="th-lg">Tier</th>
                    <th class="th-lg">Date</th>
                    <th class="th-lg">Server</th>
                  </tr>
                </thead>
              </table>
            </div>
            <!-- FINISHED MAPS TABLE -->
            <div class="table-responsive">
              <table id="FinishedMaps" class="table-sm table-borderless table-hover table-dark text-center text-nowrap">
                <thead class="z-depth-1">
                  <tr>
                    <th class="text-center th-lg">Map</th>
                    <th class="th-lg">Points</th>
                    <th class="th-lg">Time</th>
                    <th class="th-lg">Tier</th>
                    <th class="th-lg">Date</th>
                    <th class="th-lg">Server</th>
                  </tr>
                </thead>
              </table>
            </div>
            <!-- JUMPSTAT TABLE -->
            <div class="table-responsive">
              <table id="Jumpstats" class=" d-none table-sm table-borderless table-hover table-dark text-center">
                <thead class="z-depth-1">
                  <tr>
                    <th class="text-center th-lg">Type</th>
                    <th class="th-lg">Units</th>
                    <th class="th-lg">Strafes</th>
                    <th class="th-lg">Crouchbind</th>
                    <th class="th-lg">Date</th>
                    <th class="th-lg">Server</th>
                  </tr>
                </thead>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- Double Badges Modal -->
      <div class="modal fade" id="doubleBadgeModal" tabindex="-1" role="dialog" aria-labelledby="doubleBadgeModal" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
        <div class="modal-content" style="background-color: #121212;">
          <div class="modal-header">
            <div class="col-1"></div>
            <h5 class="modal-title col-10 text-center" id="doubleBadgeTitle"></h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close" style="color:white;">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body text-center">
            <div class="row">
              <div class="col-lg">
                <div class="holoSticker">
                  <img id="doubleBadgeHolo" src="">
                </div>
                <style class="holoHover"></style>
              </div>
              <div class="col-lg">
                <img id="doubleBadgeNoHolo" src="">
              </div>
            </div>
          </div>
          <div id="doubleBadgeFooter" class="modal-footer justify-content-center text-center">
          </div>
        </div>
      </div>
      </div>

      <!-- Single Badge Modal -->
      <div class="modal fade" id="singleBadgeModal" tabindex="-1" role="dialog" aria-labelledby="singleBadgeModal" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
          <div class="modal-content" style="background-color: #121212;">
            <div class="modal-header">
              <div class="col-1"></div>
              <h5 class="modal-title col-10 text-center" id="singleBadgeTitle"></h5>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close" style="color:white;">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body text-center">
              <img id="singleBadgeSticker" src="">
            </div>
            <div id="singleBadgeFooter" class="modal-footer justify-content-center text-center">
            </div>
          </div>
        </div>
        </div>
    </div>  
    
  <!-- End -->

  <!-- jQuery -->
  <script type="text/javascript" src="js/jquery.min.js"></script>
  <!-- Bootstrap tooltips -->
  <script type="text/javascript" src="js/popper.min.js"></script>
  <!-- Bootstrap core JavaScript -->
  <script type="text/javascript" src="js/bootstrap.min.js"></script>
  <!-- MDB core JavaScript -->
  <script type="text/javascript" src="js/mdb.min.js"></script>
  <!-- Datatables  -->
  <script type="text/javascript" src="js/addons/datatables.min.js"></script>
  <!-- Datatables Enum Ordering  -->
  <script type="text/javascript" src="https://cdn.datatables.net/plug-ins/1.10.21/sorting/enum.js"></script>
  <!-- Autocomplete: https://github.com/Honatas/bootstrap-4-autocomplete  -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap-4-autocomplete/dist/bootstrap-4-autocomplete.min.js" crossorigin="anonymous"></script>
  <!-- My Utility functions-->
  <script type="text/javascript" src="js/myUtils.js"></script>
  <!-- Custom scripts -->
  <script type="text/javascript">

    var RANKING = {
      19: "GOD",
      18: "DEMIGOD",
      17: "PRO+",
      16: "PRO",
      15: "SEMIPRO+",
      14: "SEMIPRO",
      13: "EXPERT+",
      12: "EXPERT",
      11: "SKILLED+",
      10: "SKILLED",
      9: "REGULAR+",
      8: "REGULAR",
      7: "CASUAL+",
      6: "CASUAL",
      5: "TRAINEE+",
      4: "TRAINEE",
      3: "SCRUB+",
      2: "SCRUB",
      1: "NEWBIE+",
      0: "NEWBIE",
    }

    var TIER = {
      7: "Death",
      6: "Extreme",
      5: "Very Hard",
      4: "Hard",
      3: "Medium",
      2: "Easy",
      1: "Very Easy",
    }

    var achievements = [
      {id: "veasy", title: "Robo", sticker: "Robo", count: 0, goal: 0, achievement : 'Finish 80% of very easy maps.'}, //tier achievements have variable goals
      {id: "easy", title: "SAS Chicken", sticker: "SAS-Chicken", count: 0, goal: 0, achievement : 'Finish 80% of easy maps.'},
      {id: "medium", title: "Cluck", sticker: "Cluck", count: 0, goal: 0, achievement : 'Finish 80% of medium maps.'},
      {id: "hard", title: "Toxic", sticker: "Toxic", count: 0, goal: 0, achievement : 'Finish 80% of hard maps.'},
      {id: "vhard", title: "Nuke Beast", sticker: "Nuke-Beast", count: 0, goal: 0, achievement : 'Finish 80% of very hard maps.'},
      {id: "extreme", title: "Aztec", sticker: "Aztec", count: 0, goal: 0, achievement : 'Finish 80% of extreme maps.'},
      {id: "death", title: "Emperor", sticker: "Emperor", count: 0, goal: 0, achievement : 'Finish 80% of death maps.'},
      {id: "bkz", title: "Move It", sticker: "Move-It", count: 0, goal: 30, achievement : 'Finish 30 maps with prefix "bkz".'},
      {id: "xc", title: "CS20 Classic", sticker: "CS20-Classic", count: 0, goal: 15, achievement : 'Finish 15 maps with prefix "xc".'},
      {id: "bhop", title: "Boost", sticker: "Boost", count: 0, goal: 13, achievement : 'Finish 13 maps with prefix "bhop".'},
      {id: "kzra", title: "Gold Web", sticker: "Gold-Web", count: 0, goal: 13, achievement : 'Finish 13 maps with prefix "kzra" or "kzro" made by Spider1.'},
      {id: "gfy", title: "Stay Frosty", sticker: "Stay-Frosty", count: 0, goal: 8, achievement : 'Finish 8 maps with prefix "gfy" made by winter Nebs and 1 impostor.'},
      {id: "zhop", title: "zPrince", sticker: "zPrince", count: 0, goal: 6, achievement : 'Finish 6 maps with prefix "zhop" or "zxp" made by zPrince.'},
      {id: "slide", title: "Surf's Up", sticker: "Surfs-Up", count: 0, goal: 10, achievement : 'Finish 10 maps with prefix "slide".'},
      {id: "go", title: "Too Old For This", sticker: "Too-Old-For-This", count: 0, goal: 32, achievement : 'Finish 32 maps with suffix "go".'},
      {id: "v2", title: "Remake Expert", sticker: "Remake-Expert", count: 0, goal: 50, achievement : 'Finish 50 maps with suffix "v2" or "v3".'},
      {id: "fix", title: "Pros Don't Fix", sticker: "Pros-Dont-Fix", count: 0, goal: 40, achievement : 'Finish 40 maps with suffix "fix".'},
      {id: "od", title: "Longevity", sticker: "Longevity", count: 0, goal: 8, achievement : 'Finish 8 maps with suffix "od" made by Overdose.'},
      {id: "final", title: "Guinea Pig", sticker: "Guinea-Pig", count: 0, goal: 20, achievement : 'Finish 20 maps with suffix "final".'},
      {id: "moto", title: "Fancy Koi", sticker: "Fancy-Koi", count: 0, goal: 9, achievement : 'Find and finish 9 maps with anime sounds on the timer, made by Gemayue'},
      {id: "crown", title: "Crown", sticker: "Crown", count: 0, goal: 2, achievement : '<a href="maps.html?map=kz_erratum_v2">' + 'kz_erratum_v2</a> PRO Runner'},
      {id: "stan", title: ["", "Stan", "Stan Holo", "Stan Holo & Stan"], sticker: ["", "Stan", "Stan-Holo", "Stan-Holo"], count: 0, goal: 3, achievement : ["?????????",'????????? and <a href="maps.html?map=kz_blackness">kz_blackness</a> PRO Runner.', '<a href="maps.html?map=kz_afterlife">kz_afterlife</a> and ????????? PRO Runner.', '<a href="maps.html?map=kz_afterlife">kz_afterlife</a> and <a href="maps.html?map=kz_blackness">kz_blackness</a> PRO Runner.']},
      {id: "viggo", title: ["", "Viggo", "Viggo Holo", "Viggo Holo & Viggo"], sticker: ["", "Viggo", "Viggo-Holo", "Viggo-Holo"], count: 0, goal: 3, achievement : ["?????????",'????????? and <a href="maps.html?map=kz_bananaysoda_v2">kz_bananaysoda_v2</a> PRO Runner.', '<a href="maps.html?map=kz_purgatory">kz_purgatory</a> and ????????? PRO Runner.', '<a href="maps.html?map=kz_purgatory">kz_purgatory</a> and <a href="maps.html?map=kz_bananaysoda_v2">kz_bananaysoda_v2</a> PRO Runner.']},
      {id: "jack", title: ["", "Jack", "Jack Holo", "Jack Holo & Jack"], sticker: ["", "Jack", "Jack-Holo", "Jack-Holo"], count: 0, goal: 3, achievement : ["?????????",'????????? and <a href="maps.html?map=kz_shell">kz_shell</a> PRO Runner.', '<a href="maps.html?map=bkz_fear4">bkz_fear4</a> and ????????? PRO Runner.', '<a href="maps.html?map=bkz_fear4">bkz_fear4</a> and <a href="maps.html?map=kz_shell">kz_shell</a> PRO Runner.']},
      {id: "joan", title: ["", "Joan", "Joan Holo", "Joan Holo & Joan"], sticker: ["", "Joan", "Joan-Holo", "Joan-Holo"], count: 0, goal: 3, achievement : ["?????????",'????????? and <a href="maps.html?map=kz_continuum">kz_continuum</a> PRO Runner.', '<a href="maps.html?map=kz_thrombosis">kz_thrombosis</a> and ????????? PRO Runner.', '<a href="maps.html?map=kz_thrombosis">kz_thrombosis</a> and <a href="maps.html?map=kz_continuum">kz_continuum</a> PRO Runner.']},
      {id: "max", title: ["", "Max", "Max Holo", "Max Holo & Max"], sticker: ["", "Max", "Max-Holo", "Max-Holo"], count: 0, goal: 3, achievement : ["?????????",'????????? and <a href="maps.html?map=kz_goquicklol_v2">kz_goquicklol_v2</a> PRO Runner.', '<a href="maps.html?map=kz_slidemap">kz_slidemap</a> and ????????? PRO Runner.', '<a href="maps.html?map=kz_slidemap">kz_slidemap</a> and <a href="maps.html?map=kz_goquicklol_v2">kz_goquicklol_v2</a> PRO Runner.']},
      {id: "boris", title: ["", "Boris", "Boris Holo", "Boris Holo & Boris"], sticker: ["", "Boris", "Boris-Holo", "Boris-Holo"], count: 0, goal: 3, achievement : ["?????????",'????????? and <a href="maps.html?map=kz_spacemario_h">kz_spacemario_h</a> PRO Runner.', '<a href="maps.html?map=kz_gemischte_gefuehlslagen">kz_gemischte_gefuehlslagen</a> and ????????? PRO Runner.', '<a href="maps.html?map=kz_gemischte_gefuehlslagen">kz_gemischte_gefuehlslagen</a> and <a href="maps.html?map=kz_spacemario_h">kz_spacemario_h</a> PRO Runner.']},
      {id: "perry", title: ["", "Perry", "Perry Holo", "Perry Holo & Perry"], sticker: ["", "Perry", "Perry-Holo", "Perry-Holo"], count: 0, goal: 3, achievement : ["?????????",'????????? and <a href="maps.html?map=kz_custos">kz_custos</a> PRO Runner.', '<a href="maps.html?map=kz_high_socks">kz_high_socks</a> and ????????? PRO Runner.', '<a href="maps.html?map=kz_high_socks">kz_high_socks</a> and <a href="maps.html?map=kz_custos">kz_custos</a> PRO Runner.']},
      {id: "chelm", title: ["", "Combine Helmet", "Combine Helmet Holo", "Combine Helmet Holo & Combine Helmet"], sticker: ["", "Combine-Helmet", "Combine-Helmet-Holo", "Combine-Helmet-Holo"], count: 0, goal: 3, achievement : ["?????????",'????????? and <a href="maps.html?map=kz_synergy_x">kz_synergy_x</a> PRO Runner.', '<a href="maps.html?map=kz_failed_fastrun_rt">kz_failed_fastrun_rt</a> and ????????? PRO Runner.', '<a href="maps.html?map=kz_failed_fastrun_rt">kz_failed_fastrun_rt</a> and <a href="maps.html?map=kz_synergy_x">kz_synergy_x</a> PRO Runner.']},
      {id: "100%", title: "Tyranids Hive Tyrant", sticker: "Tyranids-Hive-Tyrant", count: 0, goal: 1, achievement: "100% Completionist."}
    ];

    var mapsByTier = [0,0,0,0,0,0,0];
    var completedMapsByTier = [0,0,0,0,0,0,0];

    //This enum defines the order the Tier Column sorts
    $.fn.dataTable.enum( [ 'Very Easy', 'Easy', 'Medium', 'Hard', 'Very Hard', 'Extreme', 'Death' ] );

    var currentPlayerData;  //Current data of player

    //Persistent Maps Data for Tiers and Unfinished Maps
    var maps;

    //Globals so I can cancel the ajax request as soon as a new one is needed
    var playerRequest;
    var mapsRequest;
    var steamRequest;
    var jumpstatsRequest;

    //usamos este bool para evitar problemas al cambiar el mode o run apenas carga la página
    var firstfetch = true;

    //Datatables
    var t;
    var ut;
    var jt;

    var currentSteamID;
    var tableState = 1;
    var currentJumptype = "Longjump";

    //LOGIN LOGIC
    var storedSteamData = JSON.parse(localStorage.getItem('steamProfileData'));
    if (storedSteamData!=null) {
      $("#userLogin").html('<div class="dropdown"><a class="dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><img class="rounded-circle" src="' + storedSteamData.response.players[0].avatar + '"></a><div class="dropdown-menu"><a class="dropdown-item waves-effect waves-light" href="extras/steam.html?logout=true">Logout</a></div></div>');
    } else {
      $("#userLogin").html('<a onclick="loadOpenID();"><img src="https://community.cloudflare.steamstatic.com/public/images/signinthroughsteam/sits_01.png"></a>');
    }

    $(document).ready(function () {

      //Local Storage
      var storedGameMode = localStorage.getItem('game_mode');
      var storedRunType = localStorage.getItem('run_type');

      //UI Elements
      var multiPurposeInput = $("#multiPurposeInput");
      var gameModeSelector = $("input[type='radio'][name='game_mode']");
      var runTypeSelector = $("input[type='radio'][name='run_type']");

      var completionBars = [$("#VeryEasyBar"),$("#EasyBar"),$("#MediumBar"),$("#HardBar"),$("#VeryHardBar"),$("#ExtremeBar"),$("#DeathBar")];
      
      //Finished Maps Datatable Initialization
      t = $('#FinishedMaps').DataTable({        
                  "iDisplayLength": 1000,
                  "order": [[ 1, "desc" ]],
                  "columnDefs": [
                    { "targets": 5 , className: "text-left"}, //para que los servers se justifiquen en la izquierda
                    { "targets": 0, className: "text-wrap text-left"}, //la tabla usa text-truncate para que los servers sigan de largo, asi que le pongo wrap a los nombres para sobreescribirlo
                    { "orderSequence": [ "desc", "asc" ], "targets": [1,3,4] } //defines the direction the column sorts when first clicked
                  ],
                  'rowCallback': function(row, data, index){      //tengo que cambiarles el color aca porque ponerlos con span no ordena numericamente
                    if (data[1]==1000){
                      $(row).find('td:eq(1)').css('color', '#e4ae39');
                    } else if(data[1] >= 900){
                      $(row).find('td:eq(1)').css('color', '#fa292e');
                    } else if (data[1] >= 800) {
                      $(row).find('td:eq(1)').css('color', '#5d96d6');
                    } else if (data[1] >= 700) {
                      $(row).find('td:eq(1)').css('color', '#4abc8d');
                    }
                  },
                  "dom": 'rt' //con esto elijo que partes de la datatable aparezcan: default: 'lfrtip' (length slector, filter input, ¿procesing element?, table, information, pagination)
                });
      $('.dataTables_length').addClass('bs-select');

      //Unfinished Maps Datatable Initialization
      ut = $('#UnfinishedMaps').DataTable({        
                  "iDisplayLength": 1000,
                  "order": [[ 0, "asc" ]],
                  "columnDefs": [
                    { "orderSequence": [ "desc", "asc" ], "targets": [1,3,4] } //defines the direction the column sorts when first clicked
                  ],
                  'rowCallback': function(row, data, index){      //tengo que cambiarles el color aca porque ponerlos con span no ordena numericamente
                    $(row).find('td:eq(3)').addClass(data[3].toUpperCase().replace(/ /g, "-"));
                  },
                  "dom": 'rt' //con esto elijo que partes de la datatable aparezcan: default: 'lfrtip' (length slector, filter input, ¿procesing element?, table, information, pagination)
                });
      $('.dataTables_length').addClass('bs-select');

      //Unfinished Maps Datatable Initialization
      jt = $('#Jumpstats').DataTable({        
                  "iDisplayLength": 50,
                  "order": [[ 1, "desc" ]],
                  "columnDefs": [
                    { "orderSequence": [ "desc", "asc" ], "targets": [1,2,4] } //defines the direction the column sorts when first clicked
                  ],
                  'rowCallback': function(row, data, index){      //tengo que cambiarles el color aca porque ponerlos con span no ordena numericamente
                    if (currentJumptype == "Longjump" && data[1] >= 290 && $("#crouchbindCheck").is(":checked")) {
                      $(row).addClass("longjumpRainbow");
                      $(row).find('td:eq(0)').html("290 CLUB");
                    } else if (currentJumptype == "Longjump" && data[1] >= 286 && !$("#crouchbindCheck").is(":checked")) {
                      $(row).addClass("longjumpRainbow");
                      $(row).find('td:eq(0)').html("286 CLUB");
                    } else {
                      $(row).find('td:eq(1)').css('color', JumpstatColor(data[1]));
                    }
                  },
                  "dom": 'rt' //con esto elijo que partes de la datatable aparezcan: default: 'lfrtip' (length slector, filter input, ¿procesing element?, table, information, pagination)
                });
      $('.dataTables_length').addClass('bs-select');

      //Radar Chart Initialization
      var ctxR = document.getElementById("radarChart").getContext('2d');
      var myRadarChart = new Chart(ctxR, {
          type: 'radar',
          options: {
            responsive: true,
            legend : {display	: false},
            scale: {ticks: {display: false, min:0, max:100},gridLines: {color: 'grey'},angleLines: {color: 'grey'}},
            tooltips: {
              callbacks: {
                label: function(tooltipItem, data) {
                  return tooltipItem.yLabel + "%";
                }
              }
            }
          },
          data: {
            labels: ["Very Easy", "Easy", "Medium", "Hard", "Very Hard", "Extreme", "Death"],
            datasets: [
              {
                label: "Completions",
                backgroundColor: ['rgba(54, 162, 235, .7)'],
                borderColor: ['rgba(54, 162, 235, .7)'],
                borderWidth: 2
              }
            ]
          }
      });

      //First of all see if there are parameters in url. If there is one, load data from that, if there isn't load saved ones
      var URLSearchParameters = new URLSearchParams(window.location.search);
      var gameModeParameter = URLSearchParameters.get("mode");
      var runTypeParameter = URLSearchParameters.get("run");
      var vanityParameter = URLSearchParameters.get("p"); //vanity urls
      var steamIDParameter = GetSteam64(URLSearchParameters.get("steamid")); //if it's not valid, then null
      var jumpstatParameter = URLSearchParameters.get("jumpstat") || URLSearchParameters.get("jumptype");;

      //GAME MODE PARAMETER
      if (gameModeParameter == "kz_timer" || gameModeParameter == "kz_simple" || gameModeParameter == "kz_vanilla"){
        $("input[type='radio'][name=game_mode][value=" + gameModeParameter + "]").prop('checked', true);
      } else {
        //If there is no gamemode in the url, get stored gamemode if there is one
        if (storedGameMode!=null){
          $("input[type='radio'][name=game_mode][value=" + storedGameMode + "]").prop('checked', true);
        }
      }

      //RUN TYPE PARAMETER
      if (runTypeParameter == "tp"){
        $("input[type='radio'][name=run_type][value=true]").prop('checked', true);
      } else if (runTypeParameter == "pro") {
        $("input[type='radio'][name=run_type][value=false]").prop('checked', true);
      } else {
        //If there is no runtype in the url, get stored runtype if there is one
        if (storedRunType!=null){
          $("input[type='radio'][name=run_type][value=" + storedRunType + "]").prop('checked', true);
        }
      }

      //VANITY URL
      if (vanityParameter!=null) { //we prioritize vanity urls
        $.ajax({url: "https://kzprofile.kreedz.top/api/v1/steam/vanity?url=" + vanityParameter, dataType: 'json',
          success: function(result){
            if (result.response.success == 1) {
              currentSteamID = result.response.steamid;
              GetPlayerData();
            } else if (result.response.success == 42) { //no match
              alert("There is no player with this vanity url.");
            } else {
              alert("There was an error fetching this profile. The steam proxy might be down. Please report this issue.");
            }
          },
          error: function(){
            alert("There was an error fetching this profile. The steam proxy might be down. Please report this issue.");
          }
        });
      //STEAM ID PARAMETER
      } else if (steamIDParameter!=null){
        currentSteamID = steamIDParameter;
        GetPlayerData();
      } else if (storedSteamData!=null) {
        //If there is no steamid on the url, get stored id if there is one
          currentSteamID = storedSteamData.response.players[0].steamid;
          GetPlayerData();
      } else {
        //mostrar un indicador para que inicie sesion
        $('.alert').removeClass("d-none");
        $('.alert').alert();
        //window.location.replace("recent.html");
      }

      //JUMPSTAT PARAMETER
      if (jumpstatParameter!=null){
        TableStateRight();
        if (jumpstatParameter == "longjump" || jumpstatParameter == "lj") {
          currentJumptype = "Longjump";
          GetJumpstatsData();
        } else if (jumpstatParameter == "bunnyhop" || jumpstatParameter == "bhop") {
          currentJumptype = "Bhop";
          GetJumpstatsData();
        } else if (jumpstatParameter == "multibhop" || jumpstatParameter == "multihop" || jumpstatParameter == "mbhop" || jumpstatParameter == "mhop") {
          currentJumptype = "MultiBhop";
          GetJumpstatsData();
        } else if (jumpstatParameter == "ladderjump" || jumpstatParameter == "ladder") {
          currentJumptype = "Ladderjump";
          GetJumpstatsData();
        } else if (jumpstatParameter == "weirdjump" || jumpstatParameter == "wjump" || jumpstatParameter == "wj") {
          currentJumptype = "Weirdjump";
          GetJumpstatsData();
        } else if (jumpstatParameter == "dropbhop" || jumpstatParameter == "drophop" || jumpstatParameter == "dhop") {
          currentJumptype = "DropBhop";
          GetJumpstatsData();
        } else if (jumpstatParameter == "countjump" || jumpstatParameter == "cjump" || jumpstatParameter == "cj") {
          currentJumptype = "Countjump";
          GetJumpstatsData();
        }
      }

      //If Enter is pressed on the multi purpose form
      $("#multiPurposeForm").submit(function( event ) {
        //it can be a map, a player name, a steam profile, a steam64 or a steam32
        let searchValue = multiPurposeInput.val();
        
        //MAP
        if (isValidKZMap(searchValue)) {
          window.location.href = 'maps.html?map=' + searchValue;
        //STEAM 32/64
        } else if (GetSteam32(searchValue)!=null) { //this function checks both 64 and 32 bit ids, will always return the 32 if input is valid
          window.location.href = "/?steamid=" + GetSteam32(searchValue);
        //Vanity Profiles
        } else if (isValidVanityProfile(searchValue)) {
          let vanityID = searchValue.split("/id/").pop().replace("/",""); //if there is a / at the end I don't want it, little unsafe
          $.ajax({
            url: "https://kzprofile.kreedz.top/api/v1/steam/vanity?url=" + vanityID,
            dataType: 'json',
            success: function(result){
              window.location.href = "/?steamid=" + GetSteam32(result.response.steamid);
            },
            error: function(){
              alert("Either this profile is invalid or the steam proxy is down.");
            }
          });
        //Legacy Profiles
        } else if (isValidSteamProfile(searchValue)) {
          window.location.href = "/?steamid=" + GetSteam32(searchValue.split("/profiles/").pop().match(/\d+/)); //just get the numbers, safer (steam64)
        //If they search for anything else, search a player with that name
        } else {
          window.location.href = "players.html?player=" + searchValue;
        }
        return false;
      });

      //If the radio group state is changed (Game Type)
      $("input[name='game_mode']").click(function() {
        GetPlayerData();
      });

      //If the radio group state is changed (Run Type)
      $("input[name='run_type']").click(function() {
        GetPlayerData();
      });

      //What happens when i click the Refresh Button on the table
      $("#refreshButton").click(function() {
        if (tableState==2) {
          GetJumpstatsData();
        } else {
          GetPlayerData();
        }
      });
      
      //If the right arrow on table is pressed (Table State)
      $("#table-state-right").click(TableStateRight);

      function TableStateRight () {
        switch (tableState) {
          //Unfinished -> Finished
          case 0:
            tableState = 1;
            $("#table-state-title").html("Finished Maps");
            $("#table-state-left").removeClass("invisible");
            $("#UnfinishedMaps").toggleClass("d-none");
            $("#FinishedMaps").toggleClass("d-none");
            break;
          //Finished -> Jumpstats
          case 1:
            tableState = 2;
            $("#table-state-title").html(`<div class="dropdown">
                                            <a id="jumpstats-table-title" class="dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Jumpstats</a>
                                            <div class="dropdown-menu">
                                              <form class="px-4 py-1 text-white">
                                                <div class="form-check">
                                                  <input id="crouchbindCheck" type="checkbox" class="form-check-input" checked>
                                                  <label class="form-check-label" for="crouchbindCheck">
                                                    Crouchbind
                                                  </label>
                                                </div>
                                              </form>
                                              <div class="dropdown-divider"></div>
                                              <a id="Longjump" class="dropdown-item text-white">Longjumps</a>
                                              <a id="Bhop" class="dropdown-item text-white">Bhops</a>
                                              <a id="MultiBhop" class="dropdown-item text-white">MultiBhops</a>
                                              <a id="Ladderjump" class="dropdown-item text-white">Ladderjumps</a>
                                              <a id="Weirdjump" class="dropdown-item text-white">WeirdJumps</a>
                                              <a id="DropBhop" class="dropdown-item text-white">DropBhops</a>
                                              <a id="Countjump" class="dropdown-item text-white">Countjumps</a>
                                            </div>
                                          </div>`);
            $("#table-state-right").addClass("invisible");
            $("#FinishedMaps").toggleClass("d-none");
            $("#Jumpstats").toggleClass("d-none");

            break;
        }
        //everytime we change tables, clear the table filter input
        if ($('#finishedMapsSearch').val()!=""){
          $('#finishedMapsSearch').val("");
          ut.search("").draw();
        }
      }

      //If the left arrow on table is pressed (Table State)
      $("#table-state-left").click(function() {
        switch (tableState) {
          //Finished -> Unfinished
          case 1:
            tableState = 0;
            $("#table-state-title").html("Unfinished Maps");
            $("#table-state-left").addClass("invisible");
            $("#FinishedMaps").toggleClass("d-none");
            $("#UnfinishedMaps").toggleClass("d-none");
            break;
          //Jumpstats -> Finished
          case 2:
            tableState = 1;
            $("#table-state-title").html("Finished Maps");
            $("#table-state-right").removeClass("invisible");
            $("#Jumpstats").toggleClass("d-none");
            $("#FinishedMaps").toggleClass("d-none");
            break;
        }
        //everytime we change tables, clear the table filter input
        if ($('#finishedMapsSearch').val()!=""){
          $('#finishedMapsSearch').val("");
          t.search("").draw();
        }
      });

      //maps ajax should be called only once
      if (maps==null && mapsRequest==null){
          
        mapsRequest = $.ajax({url: "https://kztimerglobal.com/api/v2.0/maps?is_validated=true&limit=1000", dataType: 'json', success: function(result){
          
          maps = result;

          //Autocomplete Initialization
          multiPurposeInput.autocomplete({
            source: maps,
            label: "name",
            treshold:2,
            onSelectItem: onSelectAutocomplete
          });

          //if we have player data, that means that it fetched faster than maps and is waiting for maps ajax to succeed
          if (currentPlayerData != null){
            ProcessPlayerData();
          }
          //if we don't have player data, it means that maps data fetched faster, so do nothing. As soon as player data arrives, we'll start analyzing
        }});
      }

      //Autocomplete Selection Callback
      function onSelectAutocomplete (item, element) {
        window.location.href = 'maps.html?map=' + item.label;
      }

      //Getting the data from the API
      function GetPlayerData(){

        if (currentSteamID == "" || currentSteamID == null) {
          return;
        }

        if (storedSteamData != null && currentSteamID == storedSteamData.response.players[0].steamid) {
          localStorage.setItem('game_mode', gameModeSelector.groupVal());
          localStorage.setItem('run_type', runTypeSelector.groupVal());
        }

        if (runTypeSelector.groupVal() == "true"){
          history.pushState({mapParams: "1"}, "", "?steamid=" + GetSteam32(currentSteamID) + "&mode=" + gameModeSelector.groupVal() + "&run=tp");
        } else if (runTypeSelector.groupVal() == "false") {
          history.pushState({mapParams: "1"}, "", "?steamid=" + GetSteam32(currentSteamID) + "&mode=" + gameModeSelector.groupVal() + "&run=pro");
        }

        //Primero que nada borramos todos los datos para mostrar que estamos buscando unos nuevos
        t.clear();
        t.draw();
        ut.clear();
        ut.draw();

        if (playerRequest != null && playerRequest.readyState < 4) {
          playerRequest.abort();  //abort ajax request if another one was requested
        }

        //PLAYER DATA
        playerRequest = $.ajax({url: "https://kztimerglobal.com/api/v2.0/records/top?steamid64=" + currentSteamID + "&tickrate=128&stage=0&modes_list_string=" + gameModeSelector.groupVal() + "&has_teleports=" + runTypeSelector.groupVal() + "&limit=1000", dataType: 'json', success: function(result){
          
          currentPlayerData = result;

          //if we have map data, that means that it fetched faster than player and is waiting for player ajax to succeed
          if (maps != null) {
            ProcessPlayerData();
          }
          //if we don't have map data, it means that player data fetched faster, so do nothing. As soon as map data arrives, we'll start analyzing
        }});
      }

      function ProcessPlayerData () {
        if (currentPlayerData.length > 0){
          ShowPlayerData();
          if (firstfetch) {
            firstfetch = false;
            GetSteamProfile();
          }
        } else {  //si vino vacia es porque no hay datos sobre ese jugador pero tal vez tenga runs en otro modo de juego
          if (firstfetch) {
            $.ajax({url: "https://kztimerglobal.com/api/v2.0/players?steamid64_list=" + currentSteamID, dataType: 'json', success: function(result){
              if (result[0].name!=null){ //cuando no existe data del player en la api, el name viene null
                //entonces este jugador tiene tiempos, pero no en este modo de juego
                currentPlayerData = [{player_name: result[0].name, map_id: ""}]; //creamos este objeto para que muestre la info del player
                ShowPlayerData();
                firstfetch = false;
                GetSteamProfile();
                alert("This player has 0 runs in this game mode and run type.");
              } else {
                alert("This player has never played KZ smh.");
              }
            }});
          } else {
            alert("This player has 0 runs in this game mode and run type.");
          }
        }
      }

      //proceso todo ahora para mostrar la información relevante (stats) sin tener que esperar a la info visual de steam (avatar, flag, url, etc)
      function ShowPlayerData(){

        let arr = currentPlayerData;

        let player_points = 0;
        let player_wrs = 0;
        let player_900s = 0;
        let player_800s = 0;

        mapsByTier = [0,0,0,0,0,0,0];

        completedMapsByTier = [0,0,0,0,0,0,0];

        for (let i = 0; i < achievements.length; i++) {
          achievements[i].count = 0;
        }

        for (let j = 0; j < maps.length; j++) {
          if (gameModeSelector.groupVal()!="kz_simple" && maps[j].name.substring(0,3) == "skz" || gameModeSelector.groupVal()!="kz_vanilla" && maps[j].name.substring(0,3) == "vnl" || runTypeSelector.groupVal() == "true" && maps[j].name.substring(0,5) == "kzpro") {
            continue;
          }
          let mapFound = false;

          mapsByTier[maps[j].difficulty - 1] ++; //lo tengo que hacer cada vez que cambio de modo porque hay mapas especificos de simplekz y vanilla (cambia los % de completions)

          for (let i = 0; i < arr.length; i++) {
            if (maps[j].id == arr[i].map_id){ //if we get a match

              mapFound = true;

              completedMapsByTier[maps[j].difficulty - 1] ++;

              let map_name = arr[i].map_name;
              
              //PRIMERO LOS QUE SEAN EXCLUYENTES Y ORDENADOS DE MAYOR CANTIDAD A MENOR
              if (map_name.includes("bkz_")) {
                achievements[7].count ++;
              } else if (map_name.includes("xc_")) {
                achievements[8].count ++;
              } else if (map_name.includes("kz_bhop_")) {
                achievements[9].count ++;
              } else if (map_name.includes("kz_kzra_") || map_name.includes("kz_kzro_")) {
                achievements[10].count ++;
              } else if (map_name.includes("kz_gfy_")) {
                achievements[11].count ++;
              } else if (map_name.includes("kz_zxp") || map_name.includes("kz_zhop")) {
                achievements[12].count ++;
              } else if (map_name.includes("kz_2seasons") || map_name.includes("kz_21loop") || map_name.includes("kz_otakuroom") || map_name.includes("kz_whatever") || map_name.includes("agitation") || map_name.includes("kz_blindcity")) {
                achievements[19].count ++;
              }

              //I HATE THIS
              if (map_name.includes("slide")) {
                achievements[13].count ++;
              }
              if (map_name.includes("_go")) {
                achievements[14].count ++;
              }
              if (map_name.includes("_v2") || map_name.includes("_v3")) {
                achievements[15].count ++;
              }
              if (map_name.includes("fix")) {
                achievements[16].count ++;
              }
              if (map_name.includes("_od")) {
                achievements[17].count ++;
              }
              if (map_name.includes("_final")) {
                achievements[18].count ++;
              }

              if (runTypeSelector.groupVal() == "false") {
                //most common first. If at the end is 0: no sticker; 1: no holo sticker; 2: holo sticker 3: holo sticker (+ no holo in modal)
                switch (arr[i].map_id) {
                  case 220 : achievements[28].count = achievements[28].count + 1; break;
                  case 247 : achievements[22].count = achievements[22].count + 1; break;
                  case 303 : achievements[27].count = achievements[27].count + 1; break;
                  case 339 : achievements[28].count = achievements[28].count + 2; break;
                  case 542 : achievements[23].count = achievements[23].count + 2; break;
                  case 546 : achievements[20].count = achievements[20].count + 2; break;
                  case 557 : achievements[26].count = achievements[26].count + 1; break;
                  case 638 : achievements[25].count = achievements[25].count + 1; break;
                  case 641 : achievements[21].count = achievements[21].count + 1; break;
                  case 642 : achievements[21].count = achievements[21].count + 2; break;
                  case 643 : achievements[26].count = achievements[26].count + 2; break;
                  case 671 : achievements[23].count = achievements[23].count + 1; break;
                  case 683 : achievements[24].count = achievements[24].count + 1; break;
                  case 719 : achievements[27].count = achievements[27].count + 2; break;
                  case 745 : achievements[22].count = achievements[22].count + 2; break;
                  case 746 : achievements[25].count = achievements[25].count + 2; break;
                  case 748 : achievements[24].count = achievements[24].count + 2; break;
                }
              }

              let points = arr[i].points;

              //Add points to wrs,900s, 800s and total
              if (points==1000){
                player_wrs++;
                player_points += points;
              } else if (points>=900) {
                player_900s++;
                player_points += points;
              } else if (points>=800) {
                player_800s++;
                player_points += points;
              } else {
                player_points += points;
              }

              t.row.add( [
                '<a href="maps.html?map=' + map_name + '">' + map_name + '</a>',
                points,
                new Date(arr[i].time * 1000).toISOString().substr(11, 11),
                TIER[maps[j].difficulty],
                arr[i].updated_on.substr(0,10) + '<span style="font-size:0px;">-' + arr[i].updated_on.substr(11,8) + '</span>', //This is the greatest fix of all time
                arr[i].server_name
              ]);

              break;
            }
          }
          if (!mapFound) {

            ut.row.add( [
              '<a href="maps.html?map=' + maps[j].name + '">' + maps[j].name + '</a>',
              "-",
              "00:00:00.00",
              TIER[maps[j].difficulty],
              "XXXX-XX-XX",
              "-"
            ]);
          }
        }

        //don't need to update the name everytime we fetch
        if (firstfetch){
          //Name
          $("#playerName").html(arr[0].player_name);
          document.title = arr[0].player_name;
        }

        //Points
        $("#playerPoints").html(player_points.toString().replace(/(\d)(?=(\d{3})+(?!\d))/g, '$1,') + " (" + (player_points/arr.length).toFixed(2).replace(/(\d)(?=(\d{3})+(?!\d))/g, '$1,') + ")");
        
        //Rank
        //The rank is bassically dependant on avg points, but if you have less than 50k points, your rank will be decreased by an ease cubic function
        var promedio = player_points/50000;
        var easeOutCubic = (1 - (Math.pow(1 - promedio, 3)));
        if (easeOutCubic > 1) {
          easeOutCubic = 1;
        }
        ranking_placement = Math.floor(((player_points/arr.length) * easeOutCubic) * 0.02);
        $("#playerRank").html('<span class="' + RANKING[ranking_placement] + '">' + RANKING[ranking_placement] + '</span>');

        //Medals
        if (player_wrs>0){
          $("#WRs_medals").html('<img src="img/WRs.png" title="WRs" alt="WRs" width="80" height="80"> <sup><span class="badge medalWRsCount">' + player_wrs + '</span></sup>');
        } else {
          $("#WRs_medals").html('<img src="img/WRs-empty.png" title="WRs" alt="WRs" width="80" height="80">');
        }
        if (player_900s>0){
          $("#900s_medals").html('<img src="img/900s.png" title="900s" alt="900s" width="48" height="48"> <sup><span class="badge medal900sCount">' + player_900s + '</span></sup>');
        } else {
          $("#900s_medals").html('<img src="img/900s-empty.png" title="900s" alt="900s" width="48" height="48">');
        }
        if (player_800s>0){
          $("#800s_medals").html('<img src="img/800s.png" title="800s" alt="800s" width="48" height="48"> <sup><span class="badge medal800sCount">' + player_800s + '</span></sup>');
        } else {
          $("#800s_medals").html('<img src="img/800s-empty.png" title="800s" alt="800s" width="48" height="48">');
        }

        t.draw();

        ut.draw();

        UpdateCharts();

        UpdateBadges();
      }

      //focus multipurposeinput on empty key press
      $(document).on('keypress',function() {
        if ( $('input:focus').length == 0) {
          multiPurposeInput.focus();
        }
      });

      //sinconizar la search box con la tabla
      $('#finishedMapsSearch').keyup(function(){
        switch (tableState) {
          case 0:
            ut.search($(this).val()).draw();
            break;
          case 1:
            t.search($(this).val()).draw();
            break;
        }
      });

      function GetSteamProfile (){

        if (steamRequest != null && steamRequest.readyState < 4) {
          steamRequest.abort();  //this abort was usefull in previous version, now it's just over prevention.
        }

        steamRequest = $.ajax({url: "https://kzprofile.kreedz.top/api/v1/steam?steamids=" + currentSteamID, dataType: 'json', success: function(result){
          //Avatar
          $("#playerAvatar").html('<a href="' + result.response.players[0].profileurl + '" target="blank"><img src="' + result.response.players[0].avatarfull + '" class="img-responsive"></img></a>');

          //Flag
          let countryFlag = "";
          if (result.response.players[0].loccountrycode!=null){  //algunos jugadores no configuran u ocultan su pais
            countryFlag = '<img class="countryFlag" title="' + result.response.players[0].loccountrycode + '" src="https://www.countryflags.io/' + result.response.players[0].loccountrycode + '/flat/64.png">'
          }
          $("#playerName").append(countryFlag);

          if (storedSteamData!=null) {
            if (result.response.players[0].steamid == storedSteamData.response.players[0].steamid) {
              //This way we keep the login data up to date (user avatar)
              if (result.response.players[0].avatar != storedSteamData.response.players[0].avatar) {
                $("#userLogin").html('<a><img class="rounded-circle" src="' + result.response.players[0].avatar + '"></a>');
              }
              localStorage.setItem('steamProfileData', JSON.stringify(result));
            }
          }
        }});
      }

      function UpdateCharts() {
        
        let mapsTotal = mapsByTier.reduce((a, b) => a + b, 0);
        let completedMapsTotal = completedMapsByTier.reduce((a, b) => a + b, 0);

        myRadarChart.data.datasets[0].data = []; //primero vaciamos la data del chart

        for (let i = 0; i < mapsByTier.length; i++) {
          //Bars
          completionBars[i].css("width", (completedMapsByTier[i] / mapsByTier[i])*100 + "%" );
          completionBars[i].parent().attr("title",(completedMapsByTier[i] + "/" + mapsByTier[i]));
          //Radar Chart
          myRadarChart.data.datasets[0].data.push(((completedMapsByTier[i] / mapsByTier[i])*100).toFixed(2));
        }
        $("#barsTitle").html( completedMapsTotal + "/" + mapsTotal + " (" + ((completedMapsTotal/mapsTotal)*100).toFixed(2) + "%)" );

        myRadarChart.update();
      }

      function UpdateBadges () {

        let hiddenStickersContainer = $("#HiddenStickers");
        hiddenStickersContainer.html("");

        //Tiers
        for (let i = 0; i < 7; i++) {
          achievements[i].count = completedMapsByTier[i];
          achievements[i].goal = Math.round(mapsByTier[i]*0.8);
          if (achievements[i].count >= achievements[i].goal) {
            $("#" + achievements[i].id).attr({src: "img/Stickers/80/" + achievements[i].sticker + ".png", title: achievements[i].title + " [" + achievements[i].goal + "/" + achievements[i].goal + "]"});
          } else {
            $("#" + achievements[i].id).attr({src: "img/Stickers/80/" + achievements[i].sticker + "-Empty.png", title: "???? [" + achievements[i].count + "/" + achievements[i].goal + "]"});
          }
        }

        //Specials
        for (let i = 7; i < 20; i++) {
          if (achievements[i].count >= achievements[i].goal) {
            $("#" + achievements[i].id).attr({src: "img/Stickers/80/" + achievements[i].sticker + ".png", title: achievements[i].title + " [" + achievements[i].goal + "/" + achievements[i].goal + "]"});
          } else {
            $("#" + achievements[i].id).attr({src: "img/Stickers/80/" + achievements[i].sticker + "-Empty.png", title: "???? [" + achievements[i].count + "/" + achievements[i].goal + "]"});
          }
        }

        //Hidden Stickers

        //100% Completion
        let completedMapsTotal = completedMapsByTier.reduce((a, b) => a + b, 0);
        let mapsTotal = mapsByTier.reduce((a, b) => a + b, 0);
        if (completedMapsTotal/mapsTotal == 1) {
          hiddenStickersContainer.append('<a data-toggle="modal" data-target="#singleBadgeModal"><img src="img/Stickers/80/Tyranids-Hive-Tyrant.png" id="100%" title="Tyranids Hive Tyrant"></a>');
          achievements[29].count = 1;
        }


        if (runTypeSelector.groupVal() == "false") {

          //Crown
          if (achievements[20].count >= achievements[20].goal){
            hiddenStickersContainer.append('<a data-toggle="modal" data-target="#singleBadgeModal"><img src="img/Stickers/80/Crown.png" id="crown" title="Crown"></a>');
          }
          //Rest
          for (let i = 21; i < 29; i++) {
            if (achievements[i].count > 0) {
              hiddenStickersContainer.append('<a data-toggle="modal" data-target="#doubleBadgeModal"><img src="img/Stickers/80/' + achievements[i].sticker[achievements[i].count] + '.png" id="' + achievements[i].id + '" title="' + achievements[i].title[achievements[i].count] + '"></a>');
            }
          }
        }
      }

      //Update Single Badge Modal
      $("#singleBadgeModal").on('show.bs.modal', function(){

        let selectedAchievement;
        for (let i = 0; i < achievements.length; i++) {
          if (achievements[i].id == event.target.id) {
            selectedAchievement = achievements[i];
            break;
          }
        }

        //Title and Sticker (Shown/Hidden)
        if (selectedAchievement.count >= selectedAchievement.goal) {
          $("#singleBadgeTitle").html(selectedAchievement.title + "<br>" + selectedAchievement.goal + "/" + selectedAchievement.goal);
          $("#singleBadgeSticker").attr("src", "img/Stickers/260/" + selectedAchievement.sticker + ".png");
        } else {
          $("#singleBadgeTitle").html("????????? <br>" + selectedAchievement.count + "/" + selectedAchievement.goal);
          $("#singleBadgeSticker").attr("src", "img/Stickers/260/" + selectedAchievement.sticker + "-Empty.png");
        }

        //Footer
        $("#singleBadgeFooter").html(selectedAchievement.achievement);
      });

      //Update Double Badge Modal
      $("#doubleBadgeModal").on('show.bs.modal', function(){
        
        let selectedAchievement;
        for (let i = 0; i < achievements.length; i++) {
          if (achievements[i].id == event.target.id) {
            selectedAchievement = achievements[i];
            break;
          }
        }

        //Title and Sticker (Shown/Hidden)
        let modalTitle ="";
        
        //Holo
        if (selectedAchievement.count > 1) {
          modalTitle = selectedAchievement.title[2] + " & ";
          $("#doubleBadgeHolo").attr("src", "img/Stickers/260/" + selectedAchievement.sticker[3] + ".png");
          $("#doubleBadgeHolo").parent().addClass("holoSticker");
          $(".holoSticker").css('-webkit-mask-image', 'url("img/Stickers/260/' + selectedAchievement.sticker[3] + '.png")');
        } else {
          modalTitle = "????????? & ";
          $("#doubleBadgeHolo").attr("src", "img/Stickers/260/" + selectedAchievement.sticker[1] + "-Empty.png");
          $("#doubleBadgeHolo").parent().css('-webkit-mask-image', '');
          $("#doubleBadgeHolo").parent().removeClass("holoSticker");
        }
        //No Holo
        if (selectedAchievement.count == 1 || selectedAchievement.count == 3) {
          modalTitle += selectedAchievement.title[1];
          $("#doubleBadgeNoHolo").attr("src", "img/Stickers/260/" + selectedAchievement.sticker[1] + ".png");
        } else {
          modalTitle += "?????????";
          $("#doubleBadgeNoHolo").attr("src", "img/Stickers/260/" + selectedAchievement.sticker[1] + "-Empty.png");
        }

        $("#doubleBadgeTitle").html(modalTitle);

        //Footer
        $("#doubleBadgeFooter").html(selectedAchievement.achievement[selectedAchievement.count]);

      });

      //What happens when a jumptype is selected
      $("#table-state-title").on('click', 'a.dropdown-item', function() {
        currentJumptype = $(this).attr('id');
        GetJumpstatsData();
      });

      function GetJumpstatsData () {

        if (currentSteamID == "" || currentSteamID == null) {
          return;
        }

        jt.clear();
        jt.draw();

        if (jumpstatsRequest != null && jumpstatsRequest.readyState < 4) {
          jumpstatsRequest.abort();  //abort ajax request if another one is needed
        }

        let isCrouchBind = $("#crouchbindCheck").is(":checked") && currentJumptype!="Ladderjump" ? "true" : "false";
        //the jumpstats endpoint "steamid64" parameter is broken! MUST use steam_id (32bits) at least for now...
        jumpstatsRequest = $.ajax({url: "https://kztimerglobal.com/api/v2.0/jumpstats?steam_id=" + GetSteam32(currentSteamID) + "&jumptype=" + currentJumptype + "&is_crouch_bind=" + isCrouchBind + "&is_crouch_boost=" + isCrouchBind + "&limit=50", dataType: 'json', success: function(result){
          
          if (result.length>0) {

            $("#jumpstats-table-title").html(currentJumptype + "s");

            for (let i = 0; i < result.length; i++) {
              jt.row.add( [
                currentJumptype,
                result[i].distance.toFixed(4),
                result[i].strafe_count,
                result[i].is_crouch_bind == 0 ? "No" : "Yes",
                result[i].updated_on.substr(0,10) + '<span style="font-size:0px;">-' + result[i].updated_on.substr(11,8) + '</span>', //This is the greatest fix of all time
                result[i].server_id
              ]);
            }
          } else {
            alert ("No data was found.");
          }

          jt.draw();
          
        }});
      }

      //Tooltip initialization
      $('[data-toggle="tooltip"]').tooltip();
      //Copy to clipboard Functionality
      $('[data-toggle="tooltip"]').click(function(){

        let urlRunType;
        if (runTypeSelector.groupVal() == "true") {
          urlRunType = "tp";
        } else if (runTypeSelector.groupVal() == "false") {
          urlRunType = "pro";
        }

        let sharableURL = window.location.host + window.location.pathname;

        if (currentSteamID !=null) {
          if (tableState == 2 && currentJumptype != null) {
            sharableURL += "?steamid=" + GetSteam32(currentSteamID) + "&mode=" + gameModeSelector.groupVal() + "&run=" + urlRunType + "&jumpstat=" + currentJumptype.toLowerCase();
          } else {
            sharableURL += "?steamid=" + GetSteam32(currentSteamID) + "&mode=" + gameModeSelector.groupVal() + "&run=" + urlRunType;
          }
          
          const copyText = document.createElement('textarea');
          copyText.value = sharableURL;
          document.body.appendChild(copyText);
          copyText.select();
          document.execCommand('copy');
          document.body.removeChild(copyText);

          var shareTooltip = $(this)
          shareTooltip.tooltip('show');
          setTimeout(function(){
            shareTooltip.tooltip('hide');
          }, 2000);

        } else {
          alert("Please input a SteamID first.");
        }
      });

      var $cards = $(".holoSticker");
      var $style = $(".holoHover");
      $cards.on("mousemove", function(e) {
        var $card = $(this);
        var l = e.offsetX;
        var t = e.offsetY;
        var h = $card.height();
        var w = $card.width();
        var lp = Math.abs(Math.floor(100 / w * l)-100);
        var tp = Math.abs(Math.floor(100 / h * t)-100);
        var bg = `background-position: ${lp}% ${tp}%;`
        var style = `.holoSticker.active:before { ${bg} }`
        $cards.removeClass("active");
        $card.addClass("active");
        $style.html(style);
      }).on("mouseout", function() {
        $cards.removeClass("active");
      });

    });
  </script>

</body>
</html>